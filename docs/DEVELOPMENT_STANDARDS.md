# Linch Kit 开发规范

## 🎯 核心原则

### 1. 架构一致性原则
- **禁止重复实现** - 不同包中不得重复实现相同功能
- **统一接口** - 所有包必须使用统一的核心接口和类型定义
- **优先扩展** - 新功能必须优先扩展现有接口，而非创建新接口
- **依赖清晰** - 包之间的依赖关系必须清晰合理

### 2. 文件格式要求
- **TypeScript 优先** - 所有配置文件、实体文件、业务逻辑文件必须使用 TypeScript (.ts/.tsx)
- **禁止降级** - 禁止为了规避技术问题而将 .ts 文件改为 .js 格式
- **工具链修复** - 如遇到 TypeScript 支持问题，必须修复工具链而非降级文件格式

### 3. Breaking Changes 控制
- **生产禁止** - 生产代码禁止引入 breaking changes
- **临时方案限制** - 临时变通方案仅允许在开发/测试阶段使用
- **修复计划** - 所有变通方案必须有明确的修复计划和时间表

### 4. JSON 优先原则
- **优先 JSON 字段** - 优先使用 JSON 字段而非多对多关系表来减少复杂性
- **关联表限制** - 仅在需要复杂查询、索引或事务一致性时才使用关联表
- **生成器默认** - 生成器应默认推荐 JSON 字段方案
- **简化架构** - 减少数据库表数量，简化关系管理

### 5. 强制软删除
- **默认启用** - 除非明确禁用，所有实体都包含软删除字段
- **配置控制** - 提供配置选项允许用户禁用特定实体的软删除
- **索引优化** - 自动为软删除字段添加索引

## 🔧 自动生成文件规范

### 核心原则：**永远不要手动编辑自动生成的文件**

以下文件由 CLI 命令自动生成，**禁止手动编辑**：

#### Schema 相关
- `prisma/schema.prisma` - 由 `linch schema:generate:prisma` 生成
- `src/validators/generated.ts` - 由 `linch schema:generate:validators` 生成
- `src/mocks/factories.ts` - 由 `linch schema:generate:mocks` 生成
- `docs/api.json` - 由 `linch schema:generate:openapi` 生成

#### 修复流程
如果生成的文件有问题：

1. ❌ **错误做法** - 手动修改生成的文件
2. ✅ **正确做法** - 修复 packages/* 中的生成器逻辑
3. ✅ **验证修复** - 重新运行生成命令验证修复效果

### 生成器位置
- **Prisma 生成器** - `packages/schema/src/generators/prisma.ts`
- **验证器生成器** - `packages/schema/src/generators/validators.ts`
- **Mock 生成器** - `packages/schema/src/generators/mocks.ts`
- **OpenAPI 生成器** - `packages/schema/src/generators/openapi.ts`

## 📦 包架构规范

### 配置系统统一
- **单一配置系统** - 使用 `packages/core/src/types/config.ts` 中的统一配置接口
- **禁止重复定义** - 不得在不同包中创建重复的配置接口
- **配置加载** - 统一使用 `packages/core/src/config/loader.ts` 加载配置
- **环境变量生成** - 从 linch.config 自动生成 DATABASE_URL 等环境变量
- **配置安全性** - 区分服务端配置和客户端配置，防止敏感信息泄露

### 实体定义规范
- **实体位置** - 用户定义的实体放在 `src/entities/` 目录
- **包实体** - packages/* 中的实体通过插件系统自动加载
- **避免冲突** - 用户实体与包实体命名不得冲突

### CLI 系统规范
- **插件注册** - CLI 命令通过插件系统注册
- **配置提供者** - 配置加载通过配置提供者系统
- **错误处理** - 所有 CLI 命令必须有适当的错误处理

## 🚨 问题修复流程

### 1. 问题识别
- 识别问题的根本原因
- 确定是配置问题、生成器问题还是架构问题

### 2. 修复策略
- **配置问题** - 修复配置加载逻辑或配置文件
- **生成器问题** - 修复 packages/schema 中的生成器
- **架构问题** - 重构相关包的接口和实现

### 3. 验证修复
- 重新构建所有相关包
- 运行相关 CLI 命令验证
- 测试完整的功能流程

## 📝 文档要求

### 代码文档
- 所有公共接口必须有 JSDoc 注释
- 复杂逻辑必须有内联注释
- AI 相关的方法和类必须有 `@ai-*` 标签

### 架构文档
- 重大架构变更必须更新 `ai-context/` 文档
- 新增包必须有对应的架构说明
- 配置变更必须更新配置文档

### 开发文档
- 问题修复必须记录在相应的文档中
- 临时方案必须在文档中标明
- 修复计划必须有明确的时间表

## ✅ 验收标准

### 代码质量
- 所有 TypeScript 编译无错误
- 所有测试通过
- ESLint 检查通过

### 功能完整性
- CLI 命令正常工作
- 配置加载正常
- 生成的文件语法正确

### 架构一致性
- 无重复接口定义
- 包依赖关系清晰
- 配置系统统一

## 🔄 持续改进

### 定期检查
- 定期检查包之间的接口一致性
- 定期清理过时的代码和配置
- 定期更新文档

### 重构原则
- 小步快跑，逐步重构
- 保持向后兼容性
- 充分测试重构结果

---

**记住：质量比速度更重要，架构一致性比临时解决方案更重要！**
