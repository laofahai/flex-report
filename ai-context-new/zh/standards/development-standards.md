# Linch Kit 开发规范（永久性标准）

> **永久性原则**：本规范确立后仅允许三类变更：
> 1. 新增非冲突性条款
> 2. 优化表述清晰度
> 3. 补充实施细则
> 禁止修改或删除已确立的核心条款。

> **⚠️ 不可违背声明**：此文档为 Linch Kit 项目的核心开发标准，任何开发活动都必须严格遵循，不得违背或绕过任何条款。

## 🔒 核心开发标准（强制执行）

### 1. TypeScript 严格要求（强制执行）

#### 基本要求
- **所有文件必须使用 TypeScript (.ts/.tsx)**，禁止转换为 .js 绕过问题
- **修复工具链而非绕过问题**：遇到 TypeScript 错误时，必须修复根本原因
- **优先使用具体类型定义**，避免过度使用 'as xxx' 断言
- **启用严格模式**，避免使用 `any` 类型

#### 类型共享
- **通过 `@linch-kit/types` 包共享核心接口**
- **使用 Zod Schema 作为单一数据源**，自动生成 TypeScript 类型
- **tRPC 提供端到端类型安全**

#### ESLint 强制要求
- **修改后必须运行** `npx eslint --fix`
- **所有 lint 错误必须修复**，不允许提交有 lint 错误的代码
- **使用 ESLint 禁用注释时必须说明原因**

#### Node.js 环境要求
- **运行 npm/pnpm 命令时必须使用前缀**：
  ```bash
  export PATH="/home/laofahai/.nvm/versions/node/v20.19.2/bin:$PATH"
  ```

### 2. JSDoc 文档标准（必须）

**所有新增或修改的方法必须包含完整的 JSDoc 注释**：

```typescript
/**
 * @description 方法功能的详细描述，说明其用途和行为
 * @param {type} paramName - 参数的详细说明，包括类型和用途
 * @returns {type} 返回值的详细说明，包括类型和含义
 * @throws {ErrorType} 可能抛出的错误类型和触发条件
 * @example
 * ```typescript
 * // 提供具体的使用示例
 * const result = myFunction(param);
 * console.log(result); // 期望输出
 * ```
 * @since 版本信息（如 v1.0.0）
 */
```

**必需标签**：
- `@description`：详细功能描述
- `@param`：所有参数说明
- `@returns`：返回值说明
- `@throws`：可能的异常
- `@example`：使用示例
- `@since`：版本信息

### 3. ES 模块兼容性（必须）

#### 保留字冲突避免
- **禁止使用 `module` 作为变量名**（ES 模块保留字）
- **使用 `typeof module !== 'undefined'` 检查 CommonJS 环境**

#### 动态导入处理
- **为动态导入提供完整的错误处理和回退机制**
- **优先使用 ES 模块导出语法**

#### 环境检测
```typescript
// 正确的环境检测方式
if (typeof module !== 'undefined' && module.exports) {
  // CommonJS 环境
} else {
  // ES 模块环境
}
```

### 4. 架构一致性原则（必须）

#### 重复实现禁止
- **禁止跨包重复实现**，使用统一核心接口
- **公共模块实现** 所有应用模块功能应查看/packages/*下的功能是否已实现
- **优先使用现有成熟解决方案**，避免重复造轮子

#### 破坏性变更禁止
- **不允许破坏性变更**，必须修复根本原因而非创建变通方案
- **向后兼容性优先**

#### 生成文件管理
- **生成文件只能通过 CLI 命令自动生成**：
  - `prisma/schema.prisma`
  - `validators`
  - `mocks`
  - `openapi`
- **禁止手动编辑生成文件**

### 5. 包管理规范（必须）

#### 依赖管理
- **必须使用包管理器（pnpm）管理依赖**
- **禁止手动编辑包配置文件**

#### 例外情况
- **仅在复杂配置变更时**才可直接编辑包文件（如自定义脚本、构建配置）

## 🏗️ 架构设计原则

### 数据库设计
- **优先使用 JSON 字段**而非多对多关系以降低复杂性
- **默认实现强制软删除**
- **自动数据库提供商检测**用于 schema 生成
- **避免重复唯一约束**防止命名冲突

### 数据库连接配置（必须）
- **使用 PgBouncer 模式**避免 prepared statement 冲突：
  ```
  DATABASE_URL="postgresql://...?pgbouncer=true&connection_limit=1"
  ```
- **Prisma 客户端单例模式**：使用全局变量避免多实例冲突
- **优雅关闭连接**：在进程退出时调用 `$disconnect()`
- **连接池日志配置**：开发环境启用查询日志，生产环境仅错误日志

### 配置管理
- **服务器/客户端配置分离**，敏感数据存储在 .env 文件
- **统一数据库配置**在 linch.config 而非 .env 文件
- **CLI 生成配置**而非手动文件编辑

### 插件系统
- **优先使用消息/事件总线系统**而非钩子进行插件间通信
- **更好的失败处理和异步处理**

## 📦 包设计标准

### 核心包结构
- **核心包位于 /packages**，用于 npm 发布
- **应用仅包含启动器**
- **基于插件的开发**，功能模块作为插件

### CLI 和配置
- **优先使用冒号分隔命令名**（schema:command）而非破折号分隔
- **CLI 命令应修改配置**而非手动文件编辑
- **支持动态命令和配置注册**

## 🧪 测试要求

### 单元测试
- **编写代码时建议编写测试**
- **修复功能必须添加测试覆盖**
- **测试驱动开发优先**

### 验证流程
每次修改后必须运行：
```bash
# 生成 Prisma schema
pnpm linch schema:generate:prisma

# 运行 lint 检查
pnpm lint

# 运行测试（如果存在）
pnpm test
```

## 📚 文档标准（强制执行）

### 中文文档优先
- **优先使用中文文档**
- **统一 AI 上下文文档**仅在根目录
- **遵循开发工作流程** ai-context/workflows/development.md

### 代码注释
- **所有公共 API 必须有 JSDoc**
- **复杂逻辑必须有行内注释**
- **TODO 注释必须包含负责人和时间**

### 文档同步更新（强制要求）
- **每次功能更新后必须同步更新 ai-context 中的相关文档**
- **严格按照 `ai-context/zh/management/documentation-best-practices.md` 的标准执行文档维护**
- **更新内容包括但不限于**：
  - `current-progress.md` - 开发进度状态
  - 相关的技术文档和架构说明
- **文档更新必须在代码提交的同一次会话中完成**

## 🔄 开发工作流程

### 信息收集阶段
1. **使用 codebase-retrieval 工具了解当前状态**
2. **制定详细计划**，列出需要修改的文件
3. **获取所有相关符号的详细信息**

### 编辑阶段
1. **使用 str-replace-editor 而非重写文件**
2. **调用 codebase-retrieval 获取编辑相关的详细信息**
3. **保守修改，尊重现有代码库**

### 验证阶段
1. **运行所有验证命令**
2. **确保无破坏性变更**
3. **添加或更新测试**

## ⚠️ 违规处理

### 检查清单
每次开发任务完成前必须确认：
- [ ] 所有文件使用 TypeScript
- [ ] 运行了 `npx eslint --fix`
- [ ] 添加了完整的 JSDoc 注释
- [ ] 通过了所有验证命令
- [ ] 没有破坏性变更
- [ ] 使用了包管理器管理依赖
- [ ] **已同步更新 ai-context 中的相关文档**
- [ ] **已遵循文档最佳实践标准**

### 强制执行
- **任何违反此规范的代码不得合并**
- **必须修复所有违规问题后才能继续**
- **规范更新需要团队一致同意**

---

**最后更新**：2025-06-20
**版本**：v1.0.0
**状态**：永久生效，仅可优化补充
