# LinchKit 任务优先级矩阵 (基于功能完成度重构)

## 📊 优先级评估方法

基于 **功能完成度 × 业务价值** 矩阵，结合 LinchKit 的 AI-First 开发理念：

- **功能完成度**: 基于已完成的 Starter 应用基础功能进行渐进式架构演进
- **业务价值**: 对整体架构稳定性和长期扩展性的价值
- **技术风险**: 实施复杂度和依赖关系风险评估
- **AI-First 对齐度**: 与 AI-First 开发方法论的契合程度

## 🎯 基于已完成功能的架构演进策略

**已验证基础**: Starter 应用的用户认证、用户管理、tRPC 集成已完全实现并验证可行性
**演进原则**: 基于现有技术栈深度优化，避免重复造轮子，确保架构一致性

## ✅ 已完成的基础功能 (2025-06-20)

### 🎉 Starter 应用基础功能 - 完全实现

**技术验证成果**:
- ✅ **tRPC + Next.js 15**: 类型安全的 API 层，开发体验优秀
- ✅ **用户认证系统**: 登录、注册、会话管理完整实现
- ✅ **用户管理界面**: CRUD 操作、分页、搜索、权限控制
- ✅ **认证中间件**: 权限检查和路由保护机制
- ✅ **响应式 UI**: Tailwind CSS 设计，用户体验良好
- ✅ **Mock 数据系统**: 便于开发和演示，为数据库集成做好准备

**Demo 功能**:
- 🎯 **管理员账户**: admin@example.com / admin123
- 🎯 **普通用户账户**: user@example.com / user123
- 🎯 **完整用户管理**: 创建、编辑、删除、角色管理
- 🎯 **权限控制**: 基于角色的访问控制和路由保护

## 🔥 优先级 1: Starter 应用架构完善 (基座稳定化)

**目标**: 建立生产级应用基础架构，为模块化扩展做准备
**基础**: 基于已完成的用户认证、用户管理、tRPC 集成进行深度优化
**时间框架**: 1-2 周

### 1.1 数据架构统一化 🏗️ ✅ **已完成**

**业务价值**: 高 | **技术风险**: 中 | **紧急度**: 高
**完成日期**: 2025-06-21

**核心任务**:
- [x] **解决架构不一致问题**: 统一使用关联表架构
  - ✅ 决策采用关联表方案（multi-tenant entityKit）
  - ✅ 修改 linch.config.js 配置文件
  - ✅ 保持现有 Prisma schema 和 tRPC 实现
  - ✅ 验证功能完整性（9个实体正确加载）
- [ ] **统一 API 响应格式**: 建立标准的响应结构和错误处理机制
- [ ] **完善类型定义体系**: 端到端 TypeScript 类型安全保障
- [ ] **数据存储策略制定**: 关联表使用的最佳实践和标准

**验收标准**:
- ✅ 配置与实现完全一致
- [ ] API 响应格式统一规范
- [ ] 类型错误为零
- ✅ 数据存储策略文档化（ADR-006）

**实施结果**:
- ✅ 架构一致性问题完全解决
- ✅ 技术决策记录完整（ADR-006）
- ✅ 为后续开发奠定稳定基础

### 1.2 UI 组件体系建设 🎨

**业务价值**: 高 | **技术风险**: 低 | **紧急度**: 高
**依赖**: 基于已完成的 Tailwind CSS 基础
**预计完成**: 1-2 周

**核心任务**:
- [ ] **shadcn/ui 组件封装**: 基于 shadcn/ui 的标准化组件封装
  - [ ] 安装和配置 shadcn/ui 基础设施
  - [ ] 封装 Button、Input、Card 等基础组件
  - [ ] 封装 Form、Table、Modal 等复合组件
  - [ ] 建立组件 API 标准化和一致性保证
- [ ] **主题系统实现**:
  - [ ] 实现 ThemeProvider 组件和全局主题配置
  - [ ] 建立 CSS 变量系统和主题令牌定义
  - [ ] 创建预设主题（默认、深色、浅色）
  - [ ] 实现主题切换功能和持久化存储
- [ ] **可访问性和用户体验**:
  - [ ] 添加 ARIA 标签和键盘导航支持
  - [ ] 优化响应式设计和移动端适配
  - [ ] 统一加载状态和错误处理组件
  - [ ] 建立用户反馈机制（Toast、Alert、Notification）
- [ ] **文档和开发体验**:
  - [ ] 建设 Storybook 文档和组件展示
  - [ ] 创建组件使用示例和最佳实践指南
  - [ ] 完善 TypeScript 类型定义和 JSDoc 注释

**验收标准**:
- shadcn/ui 组件 100% 集成到 @linch-kit/ui 包
- 主题切换功能正常运行，支持持久化
- 用户体验一致性评分 > 90%
- 页面加载时间 < 2秒
- Storybook 文档覆盖率 > 80%

**技术实施路径**:
1. 配置 shadcn/ui 和主题系统基础设施
2. 逐步封装和替换现有 UI 组件
3. 实现主题系统和可访问性功能
4. 建设文档和测试用例

### 1.3 通用 CRUD 组件开发 ⚙️

**业务价值**: 极高 | **技术风险**: 中 | **紧急度**: 高
**依赖**: 1.2 UI 组件体系建设完成
**预计完成**: 2-3 周

**核心任务**:
- [ ] **TanStack Table 集成**: 构建高性能数据表格组件
  - [ ] 集成 TanStack Table 到 @linch-kit/ui 包
  - [ ] 支持排序、筛选、分页功能
  - [ ] 实现虚拟滚动和性能优化
  - [ ] 与现有用户管理界面集成验证
- [ ] **类型安全表单系统**: React Hook Form + Zod 深度集成
  - [ ] 与 @linch-kit/schema 包无缝集成
  - [ ] 实现自动表单生成和验证
  - [ ] 建立统一的错误处理和用户反馈
  - [ ] 支持复杂表单场景（嵌套对象、数组字段）
- [ ] **可复用视图模板**: 列表/详情/编辑视图的标准化模板
  - [ ] 创建 CRUDList、CRUDDetail、CRUDForm 组件模板
  - [ ] 支持自定义字段渲染和布局
  - [ ] 实现响应式设计和移动端适配
- [ ] **权限控制 UI 组件**: 基于 @linch-kit/auth-core 的权限控制组件
  - [ ] 实现 PermissionGate、RoleGate 组件
  - [ ] 支持字段级和操作级权限控制
  - [ ] 与主题系统集成，支持权限状态可视化

**与其他包的集成规范**:
- [ ] **@linch-kit/crud-ui 集成**: 建立 UI 组件与 CRUD 逻辑的标准接口
- [ ] **Starter 应用认证集成**: 在 starter 应用中直接实现认证 UI 组件，便于用户自定义
- [ ] **@linch-kit/schema 集成**: 自动从 Schema 生成表单和表格配置

**验收标准**:
- TanStack Table 性能测试通过（1000+ 行数据流畅滚动）
- 表单系统类型安全 100%（无 TypeScript 错误）
- 组件复用率 > 80%（跨不同业务场景）
- 权限控制精确度 100%（无权限泄露）

## 🟠 优先级 2: 模块化插件系统架构设计

**目标**: 建立可扩展、可维护的模块化架构基础
**依赖**: 优先级 1 的架构完善工作
**时间框架**: 2-3 周

### 2.1 插件 vs 应用模块的统一抽象 🔧

**业务价值**: 极高 | **技术风险**: 高 | **紧急度**: 中

**核心任务**:
- [ ] **统一模块描述格式**: 扩展 package.json + 模块元数据标准
  - 定义模块类型：系统级、业务级、功能级
  - 建立模块依赖关系描述
  - 设计版本兼容性规范
- [ ] **分层模块系统设计**:
  - 轻量级插件（功能扩展）：数据导出、通知推送
  - 重量级应用模块（业务领域）：产品管理、库存管理
  - 系统级模块（核心功能）：用户管理、权限控制
- [ ] **动态加载机制**: 完整的生命周期管理
  - install/enable/disable/uninstall 流程
  - 热重载和依赖解析
  - 错误恢复和回滚机制

**验收标准**:
- 模块描述格式标准化
- 分层架构清晰可维护
- 动态加载稳定可靠

### 2.2 模块间协作机制 🔗

**业务价值**: 高 | **技术风险**: 高 | **紧急度**: 中

**核心任务**:
- [ ] **扩展点系统设计**: hooks、filters、actions 支持模块间通信
- [ ] **跨模块事务处理**: 分布式事务协调机制
  - 数据一致性保障
  - 事务回滚和错误处理
  - 性能优化和监控
- [ ] **模块依赖关系管理**: 依赖图构建和版本兼容性检查
- [ ] **模块级权限控制**: 数据隔离和访问控制策略

**验收标准**:
- 模块通信机制稳定
- 事务处理可靠
- 依赖管理自动化
- 权限控制精确

### 2.3 系统核心配置管理 ⚙️

**业务价值**: 高 | **技术风险**: 中 | **紧急度**: 中

**关键决策点**: 系统设置功能放置位置分析

**核心任务**:
- [ ] **系统设置模块定位评估**:
  - 选项A: packages/core（系统级配置）
  - 选项B: 独立应用模块（应用级配置）
  - 分析利弊和技术影响
- [ ] **动态配置系统设计**: 支持模块配置热更新
- [ ] **配置优先级机制**: 系统 < 模块 < 用户的覆盖策略
- [ ] **配置验证和迁移**: 配置格式验证和版本迁移

**验收标准**:
- 系统设置定位明确
- 配置系统灵活可扩展
- 优先级机制清晰
- 配置迁移自动化

## 🟡 优先级 3: 核心模块开发和架构验证

**目标**: 通过实际模块开发验证架构设计的可行性
**依赖**: 优先级 2 的模块化架构设计
**时间框架**: 3-4 周

### 3.1 系统核心模块开发 🏛️

**业务价值**: 高 | **技术风险**: 中 | **紧急度**: 中

**核心任务**:
- [ ] **系统设置模块**: 配置管理、系统监控、环境信息
  - 动态配置界面
  - 系统状态监控
  - 环境变量管理
- [ ] **权限管理模块**: 角色管理、权限分配、访问控制
  - 与 @linch-kit/auth-core 深度集成
  - 细粒度权限控制
  - 权限继承和组合
- [ ] **配置中心模块**: 动态配置、环境变量管理
  - 配置热更新
  - 配置版本管理
  - 配置审计日志

**验收标准**:
- 模块功能完整可用
- 与现有系统无缝集成
- 性能和稳定性达标

### 3.2 业务示例模块开发 📦

**业务价值**: 中 | **技术风险**: 低 | **紧急度**: 低

**核心任务**:
- [ ] **产品管理模块**: 完整 CRUD 流程展示
  - 产品实体和 Schema 定义
  - 产品 CRUD API 实现
  - 产品管理前端界面
  - 产品分类和库存管理
- [ ] **库存管理模块**: 验证模块间数据协作和事务处理
  - 与产品管理模块的数据协作
  - 跨模块事务处理验证
  - 库存变更日志和审计

**验收标准**:
- 业务功能完整可用
- 模块间协作稳定
- 事务处理可靠

## 🔄 长期规划: AI 能力集成

**目标**: 渐进式引入 AI 能力，增强开发和业务体验
**时机**: 完成核心架构后 (2-3个月后)
**原则**: 不影响核心架构稳定性

### AI 能力分阶段实施

**第一阶段** (架构稳定后): 开发工具增强
- Schema 智能分析和建议
- CLI 命令智能提示
- 错误诊断和修复建议

**第二阶段** (1-2个月后): 业务功能增强
- 动态报表生成
- 接口调试助手
- 智能表单生成

**第三阶段** (2-3个月后): 生态系统增强
- 向量知识库
- 智能代码生成
- 业务流程优化

## 🔧 技术选型和架构决策

### 已验证的技术选型 ✅

**前端技术栈**:
- **UI 框架**: Tailwind CSS + shadcn/ui（已验证，开发效率高）
- **数据表格**: TanStack Table（计划集成，TypeScript 友好）
- **表单处理**: React Hook Form + Zod（与现有 @linch-kit/schema 深度集成）
- **状态管理**: tRPC 管理服务端状态 + Zustand 处理复杂客户端状态
- **路由系统**: Next.js App Router + 动态路由注册机制

**后端架构**:
- **API 层**: tRPC（已验证，类型安全优秀）
- **数据库**: Prisma + PostgreSQL，支持模块化 schema 管理
- **认证授权**: 深度集成 @linch-kit/auth-core 包

**开发工具链**:
- **构建系统**: Turborepo + tsup（ESM/CJS 双格式）
- **类型系统**: Zod 作为单一数据源，自动生成所有相关代码
- **配置管理**: 配置文件 + CLI 参数的混合方式

### 模块化设计原则

**分层模块化策略**:
- **系统级模块**（粗粒度）：用户管理、权限控制、系统配置
- **业务级模块**（中粒度）：产品管理、库存管理、订单管理
- **功能级插件**（细粒度）：数据导出、通知推送、第三方集成
- **通用组件**（跨模块复用）：数据表格、表单组件、权限控制组件

**跨模块协作机制**:
- **事务处理**: 实现分布式事务协调器，支持跨模块数据一致性
- **依赖管理**: 建立模块依赖图和版本兼容性矩阵
- **通信机制**: 事件总线 + 直接 API 调用的混合模式

## ⚠️ 风险评估与缓解策略

### 🔴 高风险项目

#### 1. 架构不一致问题 (紧急)
**风险**: 配置指定 `simplified` 但实现使用关联表，可能导致功能冲突
**影响**: 数据一致性、权限系统、扩展性
**缓解策略**:
- 立即进行架构决策：统一使用 JSON 字段 OR 关联表
- 制定详细的迁移计划和测试策略
- 建立架构一致性检查机制

#### 2. 模块化架构复杂度
**风险**: 跨模块事务处理和依赖管理复杂度高
**影响**: 系统稳定性、性能、维护成本
**缓解策略**:
- 分阶段实施，先完成基础架构再添加复杂功能
- 建立完整的测试覆盖，特别是集成测试
- 设计降级方案和错误恢复机制

### 🟡 中等风险项目

#### 3. 技术栈兼容性
**风险**: Next.js 15 + React 19 + 新版本依赖可能存在兼容性问题
**影响**: 开发效率、稳定性
**缓解策略**:
- 建立完整的集成测试
- 准备降级方案 (Next.js 14 + React 18)
- 密切关注社区反馈和更新

#### 4. 性能和扩展性
**风险**: 大型应用的性能瓶颈和扩展性限制
**影响**: 用户体验、系统可用性
**缓解策略**:
- 建立性能基准和监控
- 实施渐进式优化策略
- 设计水平扩展方案

## 📊 任务依赖关系图

```
Starter 应用基础功能 ✅ (已完成 2025-06-20)
    ↓
优先级 1: 架构完善 (1-2周)
├── 数据架构统一化
├── UI 组件体系建设
└── 通用 CRUD 组件开发
    ↓
优先级 2: 模块化架构设计 (2-3周)
├── 插件 vs 应用模块统一抽象
├── 模块间协作机制
└── 系统核心配置管理
    ↓
优先级 3: 核心模块开发 (3-4周)
├── 系统核心模块
└── 业务示例模块
    ↓
长期规划: AI 能力集成 (2-3个月后)
```

## ⚠️ 风险评估与缓解

### 🔴 高风险项目

#### 1. tRPC 包集成复杂度
**风险**: 与 auth-core、schema 的深度集成可能引入类型冲突
**缓解策略**:
- 分步集成，先完成基础功能再添加高级特性
- 建立完整的类型测试用例
- 使用 TypeScript 严格模式确保类型安全

#### 2. Monorepo 依赖管理
**风险**: workspace 依赖解析问题可能导致运行时错误
**缓解策略**:
- 统一使用 `workspace:*` 依赖声明
- 建立依赖图验证脚本
- 定期执行完整构建验证

### 🟡 中等风险项目

#### 3. Next.js 15 + React 19 兼容性
**风险**: 新版本可能存在未知兼容性问题
**缓解策略**:
- 建立完整的集成测试
- 准备降级方案 (Next.js 14 + React 18)
- 密切关注社区反馈

## 🎯 每日工作重点

### 当前工作重点 (今天 - 2025-06-20)

1. ✅ **已完成**: 修复 auth-core 包链接问题
2. ✅ **已完成**: tRPC 包集成和验证
3. ✅ **已完成**: linch-starter 基座应用前端认证集成
4. ✅ **已完成**: AuthGuard userRoles 错误修复 (2025-06-20 晚)
5. **下一步**: 架构不一致问题解决和产品管理模块开发

### 今晚完成的紧急修复 (2025-06-20 晚)

#### AuthGuard userRoles 错误修复 ✅ **已完成**

**问题**: `src/components/auth/auth-guard.tsx:110` 行出现 `userRoles is undefined` 错误
**解决方案**:
- ✅ 在 `hasRequiredRoles` 函数中添加空值保护：`const roles = userRoles || []`
- ✅ 修复 tRPC `register` 路由返回用户对象缺少 `roles` 字段
- ✅ 确保认证流程返回一致的用户对象结构
- ✅ 通过 ESLint 代码质量检查

**成果**: AuthGuard 组件现在能正确处理新注册用户，认证流程完全稳定

#### 发现的架构不一致问题 ⚠️ **需要解决**

**问题**: 配置指定使用 `simplified` 实体套件（JSON 优先架构），但实际实现使用关联表
**具体表现**:
- `linch.config.js` 中 `entityKit: 'simplified'` 指定使用 JSON 字段存储角色
- 但当前 Prisma schema 包含 `UserRole` 关联表
- tRPC 认证逻辑基于关联表查询用户角色

**影响**: 架构设计与实际实现不一致，可能导致功能冲突

### 当前工作重点 (2025-06-21)

1. ✅ **架构统一决策**: 已完成，采用关联表架构
2. **UI 组件体系建设**: shadcn/ui 集成和主题系统实现 🎯 **下一步重点**
3. **基座应用稳定性评估**: 用户体验、错误处理、性能优化

### 本周工作重点 (2025-06-21 - 2025-06-25)

1. **周一**: 架构不一致问题解决，基座应用稳定性评估
2. **周二-周三**: UI 设计系统完善，shadcn/ui 组件集成
3. **周四-周五**: @linch-kit/crud-ui 包开发计划制定和初步实现

### 下周工作重点 (2025-06-26 开始)

1. **第1周**: @linch-kit/crud-ui 包开发 (组件设计、API 接口、集成方式)
2. **第2周**: 发布流程建立 (自动化构建、版本管理、npm 发布)
3. **第3周**: 文档完善和示例创建
4. **第4周**: 生产级应用示例和部署配置

## 🔍 风险评估

### 高风险任务

1. **CLI 系统修复**: 可能涉及架构调整
2. **包集成验证**: 可能发现设计问题
3. **插件系统**: 复杂度高，可能需要重新设计

### 缓解措施

1. **分步验证**: 每个包单独验证后再集成
2. **文档先行**: 设计文档完善后再实现
3. **测试驱动**: 关键功能先写测试

## 📈 成功指标

### 短期指标 (1周内)

- [x] auth-core 包链接问题解决 ✅
- [x] tRPC 包构建成功，无类型错误 ✅
- [x] starter 应用可以正常启动和运行 ✅
- [x] 用户注册/登录流程完整可用 ✅
- [x] 前端认证集成完成 ✅

### 中期指标 (1个月内)

- [ ] 完整的 CRUD 操作界面
- [ ] 权限控制系统验证通过
- [ ] 所有核心包集成测试通过
- [ ] 性能基准达到预期目标

### 长期指标 (2-3个月内)

- [ ] 完整的 UI 组件生态
- [ ] AI 能力初步集成
- [ ] 生产级应用示例
- [ ] 完整的开发者文档

---

## 📈 成功指标和验收标准

### 优先级 1 成功指标 (1-2周内)

**数据架构统一化**:
- [ ] 架构不一致问题完全解决
- [ ] API 响应格式 100% 统一
- [ ] TypeScript 类型错误为零
- [ ] 数据存储策略文档化

**UI 组件体系建设**:
- [ ] shadcn/ui 组件 100% 集成
- [ ] 主题切换功能正常运行
- [ ] 用户体验一致性评分 > 90%
- [ ] 页面加载时间 < 2秒

**通用 CRUD 组件开发**:
- [ ] TanStack Table 性能测试通过
- [ ] 表单系统类型安全 100%
- [ ] 组件复用率 > 80%
- [ ] 权限控制精确度 100%

### 优先级 2 成功指标 (2-3周内)

**模块化架构设计**:
- [ ] 模块描述格式标准化完成
- [ ] 动态加载机制稳定性 > 99%
- [ ] 模块间通信延迟 < 100ms
- [ ] 事务处理成功率 > 99.9%

### 优先级 3 成功指标 (3-4周内)

**核心模块开发**:
- [ ] 系统模块功能完整性 100%
- [ ] 业务模块集成测试通过
- [ ] 模块间协作稳定性 > 99%
- [ ] 性能基准达到预期目标

## 🎯 关键决策点

### 立即需要决策的问题

1. **架构不一致问题解决方案**:
   - 选项A: 统一使用 JSON 字段（符合配置，简化架构）
   - 选项B: 统一使用关联表（保持当前实现，修改配置）
   - **建议**: 基于性能和扩展性需求进行技术评估

2. **系统设置模块定位**:
   - 选项A: packages/core（系统级配置）
   - 选项B: 独立应用模块（应用级配置）
   - **建议**: 分析配置管理的复杂度和扩展需求

## 📋 下一步行动计划

### 本周重点 (2025-06-21 - 2025-06-27)

**周一-周二**: 架构不一致问题解决
- 技术方案评估和决策
- 实施统一架构方案
- 验证功能完整性

**周三-周四**: UI 组件体系建设
- shadcn/ui 集成和配置
- 主题系统实现
- 现有组件迁移

**周五**: 通用 CRUD 组件开发启动
- TanStack Table 集成规划
- React Hook Form + Zod 深度集成设计

### 下周重点 (2025-06-28 开始)

- 完成通用 CRUD 组件开发
- 启动模块化架构设计
- 制定详细的技术实施计划

---

**最后更新**: 2025-06-21 (基于 Starter 应用完成状态重构)
**相关文档**: [当前进度](./current-progress.md) | [技术架构](../architecture/overview.md)
