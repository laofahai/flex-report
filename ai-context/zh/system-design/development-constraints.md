# LinchKit 开发强制要求

**文档版本**: v1.0.0
**创建日期**: 2025-06-23
**最后更新**: 2025-06-24
**维护责任**: 架构团队
**强制级别**: 不可违背

---

## ⚠️ 强制性声明

> **不可违背原则**: 本文档中的所有要求都是强制性的，任何开发活动都必须严格遵循，不得违背或绕过任何条款。违反这些要求的代码将不被接受。

---

## 🔒 TypeScript 强制要求

### 基本要求
- **所有文件必须使用 TypeScript (.ts/.tsx)**
  - 禁止使用 .js/.jsx 文件
  - 禁止通过重命名绕过类型检查
  - 必须修复类型错误而非绕过问题

- **严格模式配置**
  ```json
  {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true
  }
  ```

- **类型定义要求**
  - 禁止使用 `any` 类型，必须使用 `unknown` 替代
  - 避免过度使用 `as` 断言
  - 优先使用具体类型定义

### Zod Schema 强制规范
- **禁止使用的类型**
  - `z.any()` → 必须使用 `z.unknown()`
  - `z.record(z.any())` → 必须使用 `z.record(z.string(), z.unknown())`

- **JSON 字段类型安全**
  - 所有 JSON 字段必须明确指定键值类型
  - 避免过度嵌套的泛型类型定义
  - 大型 Schema 必须拆分为可组合单元

### DTS 构建要求
- **类型文件生成是强制要求**
  - 所有包构建必须包含完整的 .d.ts 文件
  - 禁止跳过或禁用类型生成
  - 构建后必须验证类型文件正确性

---

## 🏗️ 架构一致性要求

### 包依赖原则

请参考 [LinchKit AI 开发助手核心指导](../../../MASTER_GUIDELINES.md) 中的“包依赖关系和构建顺序”部分，了解完整的依赖链和构建顺序。

### 🚫 跨包重复实现禁止 (强制要求)
- **禁止重复实现core包已有功能**
  - 日志系统: 必须使用 `@linch-kit/core` 的 `logger`
  - 国际化: 必须使用 `@linch-kit/core` 的 `createPackageI18n`
  - 配置管理: 必须使用 `@linch-kit/core` 的 `ConfigManager`
  - 指标系统: 必须使用 `@linch-kit/core` 的 `metrics`
  - 插件系统: 必须使用 `@linch-kit/core` 的 `PluginSystem`
  - CLI系统: 必须使用 `@linch-kit/core` 的 `CLIManager`

- **禁止重复实现schema包已有功能**
  - 字段定义: 必须使用 `@linch-kit/schema` 的 `defineField`
  - 实体定义: 必须使用 `@linch-kit/schema` 的 `defineEntity`
  - 代码生成: 必须使用 `@linch-kit/schema` 的生成器

- **禁止重复实现第三方库功能**
  - 必须使用成熟的第三方解决方案
  - 不得自建已有成熟库的功能
  - 优先使用适配器模式集成第三方库

### 🔒 依赖倒置原则强制要求 (新增)
- **Core包纯度原则**
  - Core包只能包含抽象接口和基础类型定义
  - 禁止在Core包中包含任何下游包的具体实现
  - 禁止在Core包中定义特定业务领域的类型（如认证、CRUD、UI等）
  - Core包的插件系统必须保持通用性，不能包含特定插件的实现逻辑

- **下游包Core功能使用强制要求**
  - 所有下游包必须使用Core包提供的基础设施功能
  - 禁止在下游包中重复实现日志、配置、国际化等基础功能
  - 下游包与Core包的交互必须通过插件机制进行
  - 下游包必须正确注册为Core包的插件

- **插件机制使用规范**
  - 所有包间功能交互必须通过插件系统进行
  - 禁止包间直接导入具体实现类
  - 插件必须定义完整的metadata和生命周期钩子
  - 插件配置必须使用Zod Schema进行验证

### 重复实现检查清单
在任何包中添加新功能前，必须检查：
- [ ] core包是否已有相同或类似功能
- [ ] schema包是否已有相同或类似功能
- [ ] 其他已完成包是否有相同功能
- [ ] 第三方生态是否有成熟解决方案
- [ ] 是否可以通过配置或扩展现有功能实现需求

### 违规处理
- **立即删除重复实现**
- **使用现有功能重构**
- **更新相关文档和测试**

### 破坏性变更禁止
- **不允许破坏性变更**
- **必须保持向后兼容性**
- **修复根本原因而非创建变通方案**

---

## 📦 包管理强制规范

### 依赖管理
- **必须使用 pnpm 包管理器**
- **禁止手动编辑包配置文件**
  - package.json (除非复杂配置变更)
  - pnpm-lock.yaml
  - 其他包管理器配置文件

### Node.js 环境要求
- **运行 npm/pnpm 命令时必须使用环境前缀**
  ```bash
  export PATH="/home/laofahai/.nvm/versions/node/v20.19.2/bin:$PATH"
  ```

### 版本管理
- **使用 Changesets 管理版本**
- **禁止手动修改版本号**
- **必须遵循语义化版本规范**

---

## 🌐 ES 模块兼容性要求

### 模块系统
- **优先使用 ES 模块语法**
- **保持 CommonJS 兼容性**
- **正确处理动态导入**

### 保留字冲突避免
- **禁止使用 `module` 作为变量名**
- **使用正确的环境检测方式**
  ```typescript
  if (typeof module !== 'undefined' && module.exports) {
    // CommonJS 环境
  } else {
    // ES 模块环境
  }
  ```

---

## 🌍 国际化强制要求

### 基本要求
- **所有包必须支持国际化**
- **禁止自行实现 i18n 功能**
- **必须使用 @linch-kit/core 的 i18n 系统**

### 实现标准
```typescript
// 标准实现模式
import { createPackageI18n } from '@linch-kit/core'

const packageI18n = createPackageI18n({
  packageName: 'package-name',
  defaultLocale: 'en',
  defaultMessages: {
    en: { /* 英文消息 */ },
    'zh-CN': { /* 中文消息 */ }
  }
})

export const packageT = (userT?: TranslationFunction) => 
  packageI18n.getTranslation(userT)
```

### 多语言要求
- **至少支持英文 (en) 和中文 (zh-CN)**
- **使用 `packageName.key` 格式避免冲突**
- **提供默认消息确保回退机制**

---

## 📝 代码质量强制标准

### ESLint 要求
- **修改后必须运行 `npx eslint --fix`**
- **所有 lint 错误必须修复**
- **禁用注释必须说明原因**

### JSDoc 文档要求
- **所有公共 API 必须有 JSDoc 注释**
- **必需标签**: @description, @param, @returns, @throws, @example, @since
- **复杂逻辑必须有行内注释**

### 测试要求
- **同步测试开发**: 每个模块的测试必须与功能开发同步进行
- **测试覆盖率强制要求**:
  - @linch-kit/core: > 90% (基础设施包，最高要求)
  - @linch-kit/schema: > 85% (核心数据包)
  - @linch-kit/auth: > 85% (安全相关包)
  - @linch-kit/crud: > 85% (核心业务包)
  - @linch-kit/trpc: > 80% (API 层包)
  - @linch-kit/ui: > 80% (UI 组件包)
- **测试类型要求**:
  - 单元测试: 所有公共 API 和核心逻辑
  - 集成测试: 包间交互和插件系统
  - E2E 测试: 关键用户流程
- **新功能必须添加测试**
- **修复 bug 必须添加回归测试**
- **测试必须在功能开发完成前通过**

---

## 🗄️ 数据库设计约束

### Schema 设计原则
- **优先使用 JSON 字段而非多对多关系**
- **默认实现强制软删除**
- **避免重复唯一约束**

### 连接配置要求
- **使用 PgBouncer 模式**
  ```
  DATABASE_URL="postgresql://...?pgbouncer=true&connection_limit=1"
  ```
- **Prisma 客户端单例模式**
- **优雅关闭连接**

---

## 🎨 UI 组件开发约束

### shadcn/ui 集成要求
- **所有 shadcn/ui 组件必须通过官方 CLI 添加**
  ```bash
  cd packages/ui
  npx shadcn@latest add [component-name]
  ```
- **组件目标目录**: `packages/ui/src/components/`
- **保持与 shadcn/ui 更新兼容性**

### 组件复用原则
- **跨模块通用组件统一放置在 @linch-kit/ui**
- **避免重复实现相同组件**
- **遵循组件设计系统规范**

---

## 🔄 开发工作流约束

### 信息收集阶段
1. **必须使用 codebase-retrieval 工具了解现状**
2. **制定详细计划并列出修改文件**
3. **获取所有相关符号的详细信息**

### 编辑阶段
1. **必须使用 str-replace-editor 而非重写文件**
2. **调用 codebase-retrieval 获取编辑相关信息**
3. **保守修改，尊重现有代码库**

### 验证阶段
```bash
# 必须运行的验证命令
pnpm linch schema:generate:prisma
pnpm lint
pnpm test  # 如果存在测试
```

### 文档更新强制要求
- **每次开发任务完成后必须同步更新对应包的 README.md 文件**
- **中文文档标准**: 所有包的 README.md 必须使用中文编写，遵循 LinchKit 中文技术文档标准
- **文档内容要求**: 包含模块概览、快速开始、API 参考、配置说明、最佳实践等标准章节
- **文档版本同步**: README.md 版本号必须与包版本保持一致
- **示例代码更新**: 所有示例代码必须与最新 API 保持同步

### 上下文管理机制
- **上下文监控**: 当对话上下文达到 85% 容量时，必须主动保存当前进度状态
- **会话切换机制**: 自动提示用户开启新会话，并提供进度摘要和后续任务清单
- **状态传递**: 确保新会话能够无缝继承当前开发状态和上下文信息
- **进度保存格式**: 使用标准化的进度保存模板，包含当前任务、完成状态、下一步计划
- **上下文恢复验证**: 新会话开始时必须验证上下文恢复的完整性

---

## 📚 文档同步强制要求

### AI Context 文档维护
- **每次功能更新后必须同步更新相关文档**
- **更新 ai-context/zh/project/progress.md 开发进度**
- **文档更新必须在代码提交的同一会话完成**

### 模块开发进度上下文保存
- **如果某个模块未完成，必须创建固定的进度上下文文件**
- **文件命名格式**: `ai-context/zh/project/module-{包名}-progress.md`
- **必须包含内容**:
  - 当前完成的功能点
  - 遇到的技术问题和解决方案
  - 下一步开发计划
  - 相关代码文件和关键实现细节
  - 测试状态和覆盖率
- **每次开发会话结束前必须更新进度上下文**

### 包文档维护
- **包代码更新后必须同步更新 README.md**
- **包级文档最小内容要求**:
  - API 文档和使用说明
  - 安装说明和配置步骤
  - 使用示例和代码演示
  - 变更日志和版本信息

---

## ⚠️ 违规处理机制

### 检查清单
每次开发任务完成前必须确认：
- [ ] 所有文件使用 TypeScript
- [ ] 运行了 `npx eslint --fix`
- [ ] 添加了完整的 JSDoc 注释
- [ ] 通过了所有验证命令
- [ ] 没有破坏性变更
- [ ] 使用了包管理器管理依赖
- [ ] 已同步更新相关文档
- [ ] 遵循了所有架构约束

### 强制执行
- **任何违反规范的代码不得合并**
- **必须修复所有违规问题后才能继续**
- **规范更新需要团队一致同意**

---

## 🤖 AI-First 开发约束

### 代码编写原则
- **完整的 TypeScript 类型定义**
- **清晰的函数命名 (动词+名词)**
- **丰富的 JSDoc 注释**

### 配置文件要求
- **详细的配置注释**
- **明确的参数说明**
- **完整的类型定义**

### 项目经验遵循
- **优先使用现有成熟方案**
- **Schema 驱动开发**
- **渐进式开发策略**
- **质量优于速度**

---

## 🔐 安全性开发强制要求

### 密码与密钥管理
- **禁止提交任何密钥、Token、密码等敏感信息到代码库**
- **必须使用 .env + dotenv-safe 管理环境变量**
- **使用 @linch-kit/core 提供的加密工具处理敏感字段**
- **生产环境密钥必须通过安全的密钥管理系统注入**

### 依赖安全
- **定期运行 `pnpm audit` 或 `pnpm audit --prod`**
- **发现高危漏洞必须立即升级或规避依赖**
- **禁止使用已知存在安全漏洞的依赖版本**
- **新增依赖前必须进行安全评估**

### 数据安全
- **所有用户输入必须进行验证和清理**
- **敏感数据必须加密存储**
- **API 接口必须实现适当的访问控制**
- **日志中禁止记录敏感信息**

---

## 🧩 插件与模块机制强制规范

### 插件开发强制规范
- **每个插件必须定义 metadata，包括 id、name、version、dependencies**
- **插件必须支持 lazy load 和 safe unload**
- **插件间交互必须通过事件系统或 hooks，禁止直接耦合**
- **必须实现注册入口 `registerPlugin(appContext): void`**
- **插件配置必须使用 Zod Schema 定义**

### 跨插件事务控制
- **插件内数据库操作需支持跨模块事务委托**
- **使用统一的 transaction handler 包装器进行操作**
- **实现 PluginTransactionParticipant 接口参与分布式事务**
- **支持事务回滚和补偿机制**

### 插件权限控制
- **插件必须声明所需权限范围**
- **系统运行时验证插件权限**
- **插件只能访问声明的资源和API**
- **支持插件级别的资源隔离**

---

## ⚙️ CLI 工具与 DevOps 强制标准

### CLI 工具约束
- **新增 CLI 命令必须支持 --help 和标准错误处理**
- **必须使用统一的 CLI 库（commander + zod）开发**
- **CLI 命令需通过 lint、test、dts 检查**
- **命令参数必须使用 Zod 进行验证**
- **错误信息必须清晰且可操作**

### DevOps 流程标准
- **提交前自动执行 lint + test + build + dts 校验**
- **CI/CD 中强制验证每条规范**
- **PR 中必须列出变更影响的模块清单**
- **部署前必须通过所有质量检查**
- **生产环境部署必须有回滚方案**

### 构建脚本规范
- **每个包必须有标准的构建命令**
  ```json
  "scripts": {
    "build": "tsup src/index.ts --dts",
    "dev": "tsup src/index.ts --watch",
    "test": "vitest",
    "lint": "eslint . --fix"
  }
  ```
- **禁止直接使用 tsc 作为生产构建工具**
- **构建输出必须包含完整的类型定义**

---

## 🧠 AI 能力集成约束

### AI 数据处理
- **必须使用统一的向量嵌入接口**
- **不得将用户数据直接送入 API，必须进行脱敏或授权校验**
- **向量存储操作需支持 source tracking（来源追踪）**
- **AI 处理的数据必须符合隐私保护要求**

### AI 调用标准
- **调用模型必须实现重试、缓存、限流机制**
- **必须提供 fallback 与错误处理**
- **AI 响应必须进行内容安全检查**
- **支持多模型切换和负载均衡**

---

## 📁 项目结构强制规范

### Monorepo 结构强制说明
- **所有包必须位于 packages/ 目录下**
- **不得在根目录引入额外源码**
- **每个包必须有独立的 README.md、tsconfig.json、package.json**
- **包间共享代码必须通过依赖关系管理**

### 包命名一致性
- **必须统一使用 @linch-kit/[包名] 命名空间**
- **内部文件命名使用 kebab-case**
- **类/类型命名使用 PascalCase**
- **函数/变量使用 camelCase**

### API 设计一致性
- **所有接口必须采用 tRPC 统一风格**
- **返回结构必须统一为 `{ data, error, meta }` 格式**
- **错误码需集中定义并具备 i18n 支持**
- **禁止在 controller 中直接写业务逻辑**

---

## 👥 协作与代码审查强制流程

### Pull Request 要求
- **每个 PR 必须附带**：
  - 修改目的说明
  - 涉及的包及模块清单
  - 所有验证命令执行结果
  - 文档/测试更新说明
- **PR 标题必须遵循约定式提交规范**
- **必须通过所有自动化检查**

### Code Review 强制标准
- **每次合并前至少 1 人审核通过**
- **禁止自审自合并**
- **审核者必须验证代码符合所有约束**
- **必须检查测试覆盖率和文档完整性**

---

## 📊 可观测性强制要求

### 日志记录标准
- **日志采集使用统一接口**
- **插件和 API 层必须支持 traceId 贯穿**
- **必须提供错误收集与上报机制**
- **日志级别必须正确设置**
- **生产环境禁止输出调试日志**

### 监控指标要求
- **关键业务指标必须可监控**
- **性能指标必须符合约束要求**
- **错误率必须在可接受范围内**
- **资源使用必须在限制范围内**

---

**最后更新**: 2025-06-23
**版本**: v1.0.1
**状态**: 永久生效，仅可优化补充

**重要提醒**: 这些约束是 LinchKit 项目质量和一致性的基础保障，任何开发活动都必须严格遵循。
