# LinchKit 架构重新设计方案

**文档版本**: v2.0.0  
**创建日期**: 2025-06-27  
**设计类型**: 全面架构重构  
**状态**: 🚨 紧急重构  

---

## 🎯 重构背景

### 发现的严重架构问题
1. **CRUD包重复造轮子**：自建查询构建器而非使用Schema生成代码
2. **Schema包职责越界**：包含具体业务实体定义
3. **环境变量处理错误**：绕过Next.js原生.env机制
4. **CLI架构混乱**：各包各自为政，未使用Core CLI框架
5. **TypeScript一致性违反**：存在非TS解决方案

---

## 🏗️ 新架构设计原则

### 1. 严格的职责边界
```
@linch-kit/core      - 基础设施：插件、CLI、配置、日志、国际化
@linch-kit/schema    - DSL引擎：定义语法、生成器引擎（不含具体实体）
@linch-kit/auth      - 认证适配器：基于NextAuth.js的企业级扩展
@linch-kit/crud      - 数据操作：使用Schema生成的代码，不重复造轮子
@linch-kit/trpc      - API层：基于tRPC的类型安全API
```

### 2. "自建vs依赖"决策矩阵
| 功能类别 | 决策 | 理由 | 推荐库 |
|---------|------|------|--------|
| 认证系统 | 依赖 | 安全关键，成熟度要求高 | NextAuth.js |
| ORM操作 | 依赖 | 复杂度高，生态成熟 | Prisma |
| 查询构建 | 生成 | Schema驱动，类型安全 | Schema生成器 |
| 插件系统 | 自建 | 核心差异化功能 | Core包实现 |
| CLI框架 | 自建 | 统一开发体验 | Core包实现 |
| 日志系统 | 依赖 | 标准化需求 | Pino |
| 配置管理 | 混合 | 基础依赖+企业扩展 | Convict+自建 |

### 3. 统一CLI架构
```bash
pnpm linch                    # 主命令
pnpm linch schema:generate    # Schema代码生成
pnpm linch db:migrate        # 数据库迁移
pnpm linch auth:setup        # 认证配置
pnpm linch dev               # 开发模式
pnpm linch build             # 构建项目
```

---

## 📦 包重构计划

### Phase 1: Core包强化 (已完成)
- ✅ CLI框架完善
- ✅ 插件系统优化
- ✅ 配置管理统一

### Phase 2: Schema包重构 (紧急)
**当前问题**:
- ❌ 包含具体业务实体（User、Post等）
- ❌ 未集成Core CLI
- ❌ 未注册为Core插件

**重构目标**:
- ✅ 只提供DSL和生成器引擎
- ✅ 集成到`pnpm linch schema:*`命令
- ✅ 注册为Core插件
- ✅ 移除具体业务实体到starter-app

### Phase 3: CRUD包重构 (高优先级)
**当前问题**:
- ❌ 自建复杂查询构建器
- ❌ 重复实现Prisma功能
- ❌ 类型错误未解决

**重构目标**:
- ✅ 使用Schema生成的Prisma模型
- ✅ 基于生成代码的简单CRUD封装
- ✅ 权限集成通过Auth包
- ✅ 缓存通过Core包的基础设施

### Phase 4: Auth包验证 (中优先级)
**验证要点**:
- ✅ 确认基于NextAuth.js
- ✅ 验证Core功能使用
- ✅ 检查插件注册

### Phase 5: 环境变量修复 (立即)
**问题**:
- ❌ 创建了不必要的load-env脚本
- ❌ 绕过Next.js原生.env机制

**修复**:
- ✅ 删除load-env相关脚本
- ✅ 使用Next.js原生.env.local
- ✅ 配置Prisma正确读取环境变量

---

## 🚀 立即行动项

### 1. 停止当前修复工作 ✅
- 停止Schema实体定义工作
- 停止CRUD包类型修复
- 停止环境变量脚本开发

### 2. 架构问题文档化 (进行中)
- 创建问题清单
- 建立重构计划
- 更新开发约束

### 3. 重构优先级排序
1. **环境变量修复** (立即)
2. **Schema包重构** (今天)
3. **CRUD包重构** (明天)
4. **CLI统一** (本周)

---

## 📋 新增开发约束

### 强制性架构约束
1. **Schema包纯净性**：只能包含DSL和生成器，不能包含具体业务实体
2. **CLI统一性**：所有命令必须通过`pnpm linch`执行
3. **依赖决策强制**：必须按照决策矩阵选择自建vs依赖
4. **TypeScript一致性**：100%TypeScript，禁止绕过类型检查
5. **环境变量标准化**：使用框架原生机制，禁止自建加载器

### 代码审查检查点
- [ ] 是否违反包职责边界？
- [ ] 是否重复造轮子？
- [ ] 是否使用Core基础设施？
- [ ] 是否注册为Core插件？
- [ ] 是否集成CLI框架？

---

**重构结论**: LinchKit项目存在严重的架构违规问题，需要立即停止当前工作，按照新的架构设计进行全面重构。
