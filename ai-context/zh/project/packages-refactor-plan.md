# LinchKit 包重构计划

**文档版本**: v1.0.0  
**创建日期**: 2025-06-24  
**维护责任**: 架构团队  
**用途**: packages/* 目录下各包的重构评估和执行计划  

---

## 🔍 现状评估

### 已完成的清理工作
- ✅ 删除根目录下9个过期 MD 文件
- ✅ 删除各包内过期的 README.md 文件
- ✅ 废弃并删除 @linch-kit/types 包
- ✅ 修复 tsconfig.json 中的包引用
- ✅ 修复 ESLint 配置违规问题

### 包状况分析

#### 🔴 需要重构的包

##### 1. @linch-kit/schema (高优先级)
**问题**:
- DTS 构建性能严重问题（>30秒超时）
- 复杂的类型推导链导致构建瓶颈
- 存在 `any` 类型使用（违反约束）
- 过度复杂的泛型嵌套

**重构策略**: 完全重构
- 简化类型系统，移除复杂泛型推导
- 使用 `z.unknown()` 替代 `z.any()`
- 分离 UI 类型到独立模块
- 实施分层类型架构

##### 2. @linch-kit/auth (中优先级)
**问题**:
- 依赖 schema 包的复杂类型导致构建问题
- 架构过于复杂，包含过多功能
- 存在临时简化代码

**重构策略**: 渐进式重构
- 等待 schema 包重构完成
- 简化认证套件设计
- 移除复杂的企业级功能到插件

#### 🟡 需要改进的包

##### 3. @linch-kit/core (中优先级)
**问题**:
- 插件系统设计过于复杂
- 缺少企业级特性（监控、日志等）
- 类型定义分散

**改进策略**: 增强和优化
- 集成第三方库（Pino、Prometheus等）
- 简化插件系统为分阶段实施
- 整合 types 包功能

##### 4. @linch-kit/crud (低优先级)
**问题**:
- 架构相对合理但缺少测试
- 权限集成接口需要标准化

**改进策略**: 完善和测试
- 添加完整测试覆盖
- 标准化权限接口
- 优化性能

#### 🟢 状况良好的包

##### 5. @linch-kit/trpc (低优先级)
**状况**: 架构合理，符合设计规范
**改进**: 添加测试和文档

##### 6. @linch-kit/ui (低优先级)
**状况**: 基础架构正确
**改进**: 完善组件库和主题系统

---

## 🚀 重构执行计划

### 第一阶段：核心基础重构 (Week 1)

#### Day 1-3: @linch-kit/schema 完全重构
**目标**: 解决 DTS 构建性能问题

**具体任务**:
1. **类型系统重构**
   - 移除复杂泛型推导
   - 实施分层类型架构：Core → Simple → Full
   - 使用 `z.unknown()` 替代所有 `z.any()`

2. **API 简化**
   - 重新设计 `defineField` 和 `defineEntity`
   - 移除复杂的 UI 类型集成
   - 实施性能优化的类型推导

3. **构建优化**
   - 设置 DTS 构建时间监控
   - 实施增量构建策略
   - 添加性能回归测试

#### Day 4-5: @linch-kit/core 增强
**目标**: 集成企业级特性，简化插件系统

**具体任务**:
1. **第三方库集成**
   - 集成 Pino 日志系统
   - 集成 Prometheus 指标收集
   - 集成 OpenTelemetry 分布式追踪
   - 集成 @godaddy/terminus 健康检查

2. **插件系统简化**
   - Phase 1: 基础插件注册和生命周期
   - 移除复杂的事务协调功能
   - 简化钩子机制

3. **类型整合**
   - 整合原 @linch-kit/types 包功能
   - 统一类型定义和导出

### 第二阶段：业务逻辑重构 (Week 2)

#### Day 6-7: @linch-kit/auth 重构
**目标**: 基于新的 schema 包重构认证系统

**具体任务**:
1. **依赖更新**
   - 适配新的 schema 包 API
   - 移除临时简化代码

2. **架构简化**
   - 移除过于复杂的企业级功能
   - 专注核心认证和权限功能
   - 将高级功能移至插件

#### Day 8-10: @linch-kit/crud 完善
**目标**: 完善 CRUD 系统，标准化接口

**具体任务**:
1. **接口标准化**
   - 统一错误处理格式
   - 标准化权限集成接口
   - 优化查询构建器

2. **测试覆盖**
   - 添加完整单元测试
   - 添加集成测试
   - 达到 85% 测试覆盖率

### 第三阶段：API 和 UI 完善 (Week 3)

#### Day 11-12: @linch-kit/trpc 完善
**目标**: 完善 API 层，添加测试

#### Day 13-14: @linch-kit/ui 完善
**目标**: 完善 UI 组件库

---

## 📊 成功标准

### 性能指标
- Schema 包 DTS 构建时间 < 10秒
- 整体项目构建时间 < 5分钟
- 无 ESLint 错误

### 质量指标
- 测试覆盖率达到要求标准
- 所有公共 API 有 JSDoc 文档
- 无 TypeScript 类型错误

### 架构指标
- 依赖关系符合设计规范
- 无循环依赖
- 包职责边界清晰

---

## 🎯 下一步行动

### 立即开始
1. 开始 @linch-kit/schema 包的完全重构
2. 设置性能监控基准
3. 建立重构进度跟踪

### 风险缓解
- 保留原代码作为参考
- 分阶段验证重构结果
- 建立回滚机制

---

**重构原则**: 质量优于速度，架构一致性优于临时解决方案
