# 架构决策记录 (ADR)

## 📋 决策概述

本文档记录了 Linch Kit 项目的重要架构决策，包括技术选型、设计模式、系统架构等关键决策。

## 🏗️ 系统架构决策

### ADR-001: Monorepo 架构选择
**决策日期**: 2024-12-15  
**状态**: ✅ 已确认

**决策**: 采用 Turborepo + pnpm 的 Monorepo 架构

**背景**: 需要管理多个相关包，确保代码共享和统一构建

**决策理由**:
- ✅ 代码共享和复用效率高
- ✅ 统一的构建和发布流程
- ✅ 依赖管理简化
- ✅ 开发体验一致

**替代方案**: 多仓库架构、Nx、Lerna
**影响**: 提升开发效率，但增加初始设置复杂度

### ADR-002: 插件系统架构
**决策日期**: 2024-12-16  
**状态**: ✅ 已确认

**决策**: 基于 Odoo 理念的运行时插件系统

**背景**: 需要支持企业级应用的模块化开发和部署

**决策理由**:
- ✅ 业务模块和功能插件统一管理
- ✅ 运行时动态加载和组合
- ✅ 支持跨模块事务管理
- ✅ 灵活的扩展点系统

**技术实现**:
- 独立的 `@linch-kit/plugin-system` 包
- 统一的插件接口和生命周期
- 扩展点注册和钩子系统
- 分布式事务协调器

### ADR-003: Schema-First 设计
**决策日期**: 2024-12-15  
**状态**: ✅ 已确认

**决策**: 以 Zod Schema 为单一数据源

**背景**: 需要减少重复定义，提高开发效率

**决策理由**:
- ✅ 减少重复定义
- ✅ 类型安全
- ✅ 自动化代码生成
- ✅ 开发效率高
- ✅ 支持模块化 Schema 合并

**影响**: 所有数据相关代码都基于 Schema 生成

## 📦 包架构决策

### ADR-004: CRUD 包拆分策略
**决策日期**: 2024-12-18  
**状态**: ✅ 已确认

**决策**: 拆分为 `@linch-kit/crud` (核心) + `@linch-kit/crud-ui` (UI)

**背景**: 需要平衡功能完整性和包的灵活性

**决策理由**:
- ✅ 关注点分离，逻辑与 UI 解耦
- ✅ 框架无关，核心包可支持多种 UI 框架
- ✅ 更好的树摇，用户可按需引入
- ✅ 灵活性，用户可以只使用逻辑层

**架构模式**: Manager + Operations + State 的分层架构

### ADR-005: API 层架构
**决策日期**: 2024-12-15  
**状态**: ✅ 已确认

**决策**: tRPC 作为独立包，不集成到 core

**背景**: 需要保持技术栈的灵活性

**决策理由**:
- ✅ 保持技术栈无关性
- ✅ 支持未来的 GraphQL 等其他 API 层
- ✅ 独立版本管理
- ✅ 可选依赖，不强制使用

**影响**: 用户可以选择不同的 API 层技术

### ADR-006: 权限系统架构
**决策日期**: 2024-12-16  
**状态**: ✅ 已确认

**决策**: 基于 NextAuth.js 的模块化权限系统

**背景**: 需要支持企业级的细粒度权限控制

**决策理由**:
- ✅ 复用现有的 auth-core 基础
- ✅ 支持模块级权限定义
- ✅ 与 tRPC 中间件集成
- ✅ 灵活的权限扩展机制

**权限层级**:
- 操作级权限 (CRUD 操作)
- 字段级权限 (字段可见性)
- 行级权限 (数据行访问)

## 🎨 UI 架构决策

### ADR-007: UI 组件库选择
**决策日期**: 2024-12-15  
**状态**: ✅ 已确认

**决策**: shadcn/ui + 自研 CRUD 组件

**背景**: 需要平衡开发效率和定制能力

**决策理由**:
- ✅ 基础组件使用成熟方案 (shadcn/ui)
- ✅ 业务组件自主可控
- ✅ 支持模块化视图注册
- ✅ 通用 CRUD 场景覆盖

**组件设计**: 采用组合式组件设计，支持高度自定义

### ADR-008: 状态管理策略
**决策日期**: 2024-12-18  
**状态**: ✅ 已确认

**决策**: 内置轻量级状态管理，支持外部状态库集成

**背景**: 需要平衡简单性和灵活性

**决策理由**:
- ✅ 零依赖，核心包不依赖外部状态库
- ✅ 灵活集成，可以与 Redux、Zustand 等集成
- ✅ 性能优化，针对 CRUD 场景优化
- ✅ 简单易用，对于简单场景无需额外状态库

## 🔧 技术实现决策

### ADR-009: 事件系统设计
**决策日期**: 2024-12-18  
**状态**: ✅ 已确认

**决策**: 采用类型安全的事件系统

**背景**: 需要支持插件和自定义逻辑扩展

**决策理由**:
- ✅ 扩展性，支持插件和自定义逻辑
- ✅ 类型安全，事件参数类型检查
- ✅ 调试友好，清晰的事件流程
- ✅ 集成便利，易于与外部系统集成

**事件类型**: before/after 操作事件，状态变更事件

### ADR-010: 数据源抽象
**决策日期**: 2024-12-18  
**状态**: ✅ 已确认

**决策**: 定义通用的 DataSource 接口，支持多种后端

**背景**: 需要支持不同的后端技术栈

**决策理由**:
- ✅ 后端无关，支持 REST、GraphQL、tRPC 等
- ✅ 可测试性，易于 mock 和测试
- ✅ 灵活性，用户可以自定义数据源实现
- ✅ 标准化，统一的数据操作接口

**接口设计**: 标准的 CRUD 操作接口 + 分页支持

## 🚀 性能架构决策

### ADR-011: 构建性能优化
**决策日期**: 2024-12-15  
**状态**: ✅ 已确认

**决策**: Turborepo 智能缓存 + 并行构建

**背景**: Monorepo 构建性能是关键瓶颈

**优化策略**:
- ✅ 智能缓存，避免重复构建
- ✅ 并行构建，提升构建速度
- ✅ 增量构建，只构建变更部分
- ✅ 依赖图优化，最小化构建范围

### ADR-012: 运行时性能优化
**决策日期**: 2024-12-18  
**状态**: ✅ 已确认

**决策**: 多层次性能优化策略

**优化策略**:
- ✅ 懒加载，按需加载组件和数据
- ✅ 虚拟滚动，处理大数据集
- ✅ 智能缓存，减少重复请求
- ✅ 代码分割，减少初始加载时间

## 📊 决策影响分析

### 正面影响
- ✅ **开发效率**: 统一架构大幅提升开发速度
- ✅ **代码质量**: 标准化设计模式和最佳实践
- ✅ **可维护性**: 清晰的架构和文档
- ✅ **可扩展性**: 插件化架构支持灵活扩展

### 潜在风险
- ⚠️ **复杂性**: 高度抽象可能增加学习成本
- ⚠️ **性能**: 多层抽象可能带来性能开销
- ⚠️ **依赖**: 对特定技术栈的依赖

### 风险缓解策略
- 📚 **文档完善**: 提供详细的架构文档和使用指南
- 🎯 **渐进式设计**: 支持从简单到复杂的渐进式使用
- ⚡ **性能监控**: 建立性能监控和优化机制
- 🧪 **充分测试**: 确保架构决策的正确性

---

**维护说明**: 本文档记录重要的架构决策，每个决策都应包含背景、理由、替代方案和影响分析。
**更新频率**: 重大架构变更时更新
**相关文档**: [技术选型](./technology-choices.md) | [发布策略](./publishing-strategy.md)
