# LinchKit "自建vs依赖" 决策矩阵

**文档版本**: v1.0.0  
**创建日期**: 2025-06-27  
**文档类型**: 架构决策指南  
**适用范围**: 所有LinchKit包开发  

---

## 🎯 决策原则

### LinchKit核心原则
1. **不重复造轮子** - 优先使用成熟的第三方库
2. **企业级标准** - 选择经过生产验证的解决方案
3. **AI友好** - 选择AI容易理解和处理的技术栈
4. **类型安全** - 100% TypeScript支持
5. **可维护性** - 减少自建代码的维护负担

---

## 📊 决策矩阵

### 🔴 必须依赖第三方库 (禁止自建)

| 功能类别 | 推荐库 | 理由 | 禁止自建原因 |
|---------|--------|------|-------------|
| **认证系统** | NextAuth.js | 安全关键，生态成熟 | 安全漏洞风险极高 |
| **ORM/数据库** | Prisma | 类型安全，生态完善 | 复杂度极高，维护成本巨大 |
| **HTTP客户端** | fetch/axios | 标准化，广泛支持 | 网络协议复杂性 |
| **日志系统** | Pino | 性能优秀，结构化 | 性能优化复杂 |
| **加密/哈希** | Node.js crypto | 安全标准 | 安全实现风险 |
| **JSON Schema** | Zod | 类型推导，运行时验证 | 类型系统复杂性 |
| **CLI解析** | Commander.js | 功能完整，稳定 | 参数解析复杂性 |
| **文件监听** | Chokidar | 跨平台兼容 | 平台差异处理复杂 |
| **国际化基础** | i18next | 标准化，功能完整 | 本地化复杂性 |

### 🟡 混合策略 (基础依赖+企业扩展)

| 功能类别 | 基础库 | 自建扩展 | 扩展内容 |
|---------|--------|---------|---------|
| **配置管理** | Convict | 多租户、热更新 | 企业级特性 |
| **可观测性** | OpenTelemetry | 业务指标、告警 | 业务层监控 |
| **缓存系统** | LRU-cache/Redis | 分布式、策略 | 缓存策略优化 |
| **事件系统** | EventEmitter3 | 类型安全、中间件 | 企业级事件处理 |
| **错误处理** | 标准Error | 分类、追踪、恢复 | 企业级错误管理 |

### 🟢 必须自建 (核心差异化功能)

| 功能类别 | 自建原因 | 实现要求 | 依赖基础 |
|---------|---------|---------|---------|
| **插件系统** | LinchKit核心架构 | 生命周期、依赖管理 | EventEmitter3 |
| **Schema DSL** | 领域特定语言 | 类型推导、代码生成 | Zod, ts-morph |
| **代码生成器** | Schema驱动核心 | 模板引擎、文件生成 | ts-morph |
| **CLI框架** | 统一开发体验 | 插件化命令、上下文 | Commander.js |
| **权限引擎** | 企业级RBAC/ABAC | 规则引擎、策略评估 | 无 |

---

## 🚫 严格禁止的重复造轮子

### 数据库相关
- ❌ **查询构建器** - 使用Prisma或Schema生成
- ❌ **连接池** - 使用Prisma内置
- ❌ **迁移系统** - 使用Prisma Migrate
- ❌ **ORM功能** - 使用Prisma Client

### 网络相关
- ❌ **HTTP服务器** - 使用Next.js/Express
- ❌ **WebSocket** - 使用成熟库
- ❌ **API客户端** - 使用tRPC/fetch

### 安全相关
- ❌ **密码哈希** - 使用bcrypt/argon2
- ❌ **JWT处理** - 使用jose/jsonwebtoken
- ❌ **加密解密** - 使用Node.js crypto
- ❌ **CSRF保护** - 使用框架内置

### 工具相关
- ❌ **文件系统操作** - 使用fs-extra
- ❌ **路径处理** - 使用Node.js path
- ❌ **时间处理** - 使用date-fns
- ❌ **UUID生成** - 使用uuid库

---

## 📋 决策检查清单

### 开发前检查
- [ ] 是否存在成熟的第三方库？
- [ ] 该功能是否属于"必须依赖"类别？
- [ ] 自建是否有明确的差异化价值？
- [ ] 是否有足够的维护资源？
- [ ] 是否符合LinchKit架构原则？

### 代码审查检查
- [ ] 是否违反了"禁止自建"规则？
- [ ] 是否正确使用了推荐的第三方库？
- [ ] 自建功能是否有充分的理由？
- [ ] 是否遵循了混合策略的边界？
- [ ] 是否有完整的测试覆盖？

---

## 🔄 决策更新机制

### 定期审查
- **频率**: 每季度审查一次
- **触发条件**: 新技术出现、库版本重大更新
- **审查内容**: 决策矩阵的准确性和完整性

### 例外处理
- **申请流程**: 技术委员会审批
- **文档要求**: 详细的技术分析和风险评估
- **时限**: 例外决策有效期不超过6个月

---

## 📚 参考资源

### 技术选型参考
- [npm trends](https://npmtrends.com/) - 库流行度对比
- [Snyk Advisor](https://snyk.io/advisor/) - 安全性和质量评估
- [GitHub Stars](https://github.com/) - 社区活跃度
- [TypeScript支持](https://www.typescriptlang.org/) - 类型定义质量

### LinchKit特定考虑
- AI代码理解友好度
- 企业级功能需求
- 多租户架构支持
- 性能和可扩展性要求

---

**决策原则**: 当有疑问时，优先选择依赖成熟的第三方库，除非有明确的差异化价值和充足的维护资源。
