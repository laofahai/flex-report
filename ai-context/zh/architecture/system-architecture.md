# 系统架构详解

## 🏗️ 整体架构概览

Linch Kit 采用模块化、插件化的架构设计，基于 Odoo 理念构建企业级快速开发框架。

### 架构原则
- **AI-First**: 所有组件都便于 AI 理解和处理
- **模块化**: 功能按包分离，支持独立开发和部署
- **插件化**: 支持运行时插件加载和扩展
- **类型安全**: 端到端 TypeScript 支持
- **Schema 驱动**: 使用 Zod 作为单一数据源

## 📦 包架构设计

### 核心包层次结构

```
@linch-kit/types (基础类型)
    ↓
@linch-kit/core (CLI + 配置 + 工具)
    ↓
@linch-kit/schema (数据模式系统)
    ↓
@linch-kit/auth-core (认证和权限)
    ↓
@linch-kit/crud (CRUD 操作核心)
    ↓
@linch-kit/trpc (API 层集成)
    ↓
@linch-kit/ui (基础 UI 组件)
    ↓
@linch-kit/crud-ui (CRUD UI 组件)
@linch-kit/auth-ui (认证 UI 组件)
```

### 包职责分工

#### 1. @linch-kit/types
- **职责**: 共享 TypeScript 类型定义
- **依赖**: 无
- **提供**: 基础类型、接口定义

#### 2. @linch-kit/core
- **职责**: CLI 系统、配置管理、基础工具
- **依赖**: types
- **提供**: 命令系统、插件加载、配置管理

#### 3. @linch-kit/schema
- **职责**: 数据模式定义和代码生成
- **依赖**: core, types
- **提供**: Zod 实体定义、Prisma 生成、验证器

#### 4. @linch-kit/auth-core
- **职责**: 认证和权限管理
- **依赖**: core, schema, types
- **提供**: 认证提供商、权限系统、会话管理

#### 5. @linch-kit/crud
- **职责**: CRUD 操作核心逻辑
- **依赖**: auth-core, schema, core, types
- **提供**: CRUDManager、操作抽象、权限集成

#### 6. @linch-kit/trpc
- **职责**: tRPC 集成和类型安全 API
- **依赖**: crud, auth-core, schema, core, types
- **提供**: tRPC 路由生成、中间件、类型安全 API

#### 7. @linch-kit/ui
- **职责**: 基础 UI 组件库
- **依赖**: types
- **提供**: shadcn/ui 组件、主题系统

#### 8. @linch-kit/crud-ui
- **职责**: CRUD 相关 UI 组件
- **依赖**: crud, ui, auth-core, types
- **提供**: 数据表格、表单、列表组件

#### 9. @linch-kit/auth-ui
- **职责**: 认证相关 UI 组件
- **依赖**: auth-core, ui, types
- **提供**: 登录表单、权限门控、用户管理

## 🔧 技术栈集成

### 前端技术栈
```
Next.js 14 (App Router)
    ↓
React 18 + TypeScript
    ↓
Tailwind CSS + shadcn/ui
    ↓
@linch-kit/ui + @linch-kit/crud-ui + @linch-kit/auth-ui
```

### 后端技术栈
```
Next.js API Routes
    ↓
tRPC (@linch-kit/trpc)
    ↓
@linch-kit/crud + @linch-kit/auth-core
    ↓
Prisma ORM (@linch-kit/schema)
    ↓
PostgreSQL / MySQL / SQLite
```

### 开发工具链
```
Turborepo (Monorepo 管理)
    ↓
pnpm (包管理)
    ↓
tsup (构建工具)
    ↓
TypeScript (类型检查)
    ↓
@linch-kit/core (CLI 工具)
```

## 🔌 插件系统架构

Linch Kit 采用三层插件架构，每层有不同的职责和通信机制：

### 1. CLI 插件系统
**职责**: 命令行工具和开发时扩展
- **命令注册**: 动态注册新的 CLI 命令（如 `schema:generate`, `db:migrate`）
- **配置扩展**: 扩展项目配置选项
- **代码生成**: 提供代码生成和脚手架功能
- **开发工具**: 集成开发和调试工具

**通信机制**:
- 命令注册器 (Command Registry)
- 配置合并器 (Config Merger)
- 插件发现机制 (Plugin Discovery)

### 2. 应用模块系统（Odoo 风格）
**职责**: 业务功能模块
- **业务逻辑**: 完整的业务功能实现（如 CRM、WMS、财务）
- **数据模型**: 模块特定的数据结构和关系
- **API 端点**: 模块相关的 tRPC 路由
- **用户界面**: 模块的前端组件和页面

**通信机制**:
- 模块注册器 (Module Registry)
- 服务依赖注入 (Service DI)
- 模块间 API 调用
- 共享数据模型

### 3. 功能插件系统
**职责**: 可选功能扩展和第三方集成
- **功能增强**: 为现有模块添加可选功能（如支付、通知）
- **第三方集成**: 集成外部服务和 API
- **横切关注点**: 日志、监控、缓存等
- **可插拔组件**: 可替换的功能实现

**通信机制**:
- 事件总线系统 (Event Bus)
- 钩子系统 (Hook System)
- 中间件机制 (Middleware)
- 配置驱动激活

### 插件加载机制
```
应用启动
    ↓
插件发现 (packages/*/plugins/)
    ↓
依赖解析和分层识别
    ↓
CLI 插件注册 → 命令系统
    ↓
应用模块注册 → 业务系统
    ↓
功能插件注册 → 扩展系统
    ↓
运行时可用
```

## 🗄️ 数据流架构

### Schema 驱动的数据流
```
Zod Schema 定义
    ↓
自动生成 Prisma Schema
    ↓
自动生成验证器 (create/update/response/query)
    ↓
自动生成 Mock 数据
    ↓
自动生成 OpenAPI 文档
    ↓
自动生成 tRPC 路由
    ↓
自动生成 CRUD UI 组件
```

### 权限集成数据流
```
用户请求
    ↓
认证中间件 (JWT 验证)
    ↓
权限检查 (操作级/字段级/行级)
    ↓
CRUD 操作执行
    ↓
数据过滤和脱敏
    ↓
响应返回
```

## 🔄 事件系统架构

### 事件类型
1. **生命周期事件**: 应用启动、关闭
2. **CRUD 事件**: 创建前/后、更新前/后、删除前/后
3. **认证事件**: 登录、登出、权限变更
4. **插件事件**: 插件加载、卸载、错误

### 事件流
```
事件触发
    ↓
事件总线
    ↓
监听器匹配
    ↓
异步处理
    ↓
结果聚合
    ↓
回调执行
```

## 🏢 企业级特性架构

### 多租户支持
```
租户识别 (域名/子域名/路径)
    ↓
租户上下文注入
    ↓
数据隔离 (Row Level Security)
    ↓
权限隔离 (租户级权限)
    ↓
配置隔离 (租户级配置)
```

### 工作流引擎
```
工作流定义 (BPMN/JSON)
    ↓
流程实例化
    ↓
任务分配
    ↓
状态跟踪
    ↓
审批流程
    ↓
完成回调
```

### 审计日志
```
操作拦截
    ↓
上下文收集 (用户/时间/操作/数据)
    ↓
日志存储 (数据库/文件/外部服务)
    ↓
查询接口
    ↓
报表生成
```

## 🚀 性能优化架构

### 缓存策略
1. **内存缓存**: 热点数据缓存
2. **Redis 缓存**: 分布式缓存
3. **CDN 缓存**: 静态资源缓存
4. **浏览器缓存**: 客户端缓存

### 懒加载策略
1. **代码分割**: 按路由分割
2. **组件懒加载**: 按需加载组件
3. **插件懒加载**: 按需加载插件
4. **数据懒加载**: 分页和虚拟滚动

### 构建优化
1. **Tree Shaking**: 移除未使用代码
2. **Bundle 分析**: 优化包大小
3. **并行构建**: 多包并行构建
4. **增量构建**: 只构建变更部分

## 🔒 安全架构

### 认证安全
1. **JWT 令牌**: 无状态认证
2. **刷新令牌**: 安全令牌更新
3. **多因素认证**: 增强安全性
4. **会话管理**: 安全会话控制

### 权限安全
1. **RBAC**: 基于角色的访问控制
2. **ABAC**: 基于属性的访问控制
3. **字段级权限**: 细粒度权限控制
4. **行级安全**: 数据行级访问控制

### 数据安全
1. **输入验证**: Zod 模式验证
2. **SQL 注入防护**: Prisma ORM 保护
3. **XSS 防护**: 输出转义
4. **CSRF 防护**: 令牌验证

## 📋 架构决策记录 (ADR)

### ADR-001: Monorepo 架构选择
**决策日期**: 2024-12-15
**状态**: ✅ 已确认

**决策**: 采用 Turborepo + pnpm 的 Monorepo 架构

**背景**: 需要管理多个相关包，确保代码共享和统一构建

**决策理由**:
- ✅ 代码共享和复用效率高
- ✅ 统一的构建和发布流程
- ✅ 依赖管理简化
- ✅ 开发体验一致

**替代方案**: 多仓库架构、Nx、Lerna
**影响**: 提升开发效率，但增加初始设置复杂度

### ADR-002: 插件系统架构
**决策日期**: 2024-12-16
**状态**: ✅ 已确认

**决策**: 基于 Odoo 理念的运行时插件系统

**背景**: 需要支持企业级应用的模块化开发和部署

**决策理由**:
- ✅ 业务模块和功能插件统一管理
- ✅ 运行时动态加载和组合
- ✅ 支持跨模块事务管理
- ✅ 灵活的扩展点系统

**技术实现**:
- 独立的 `@linch-kit/plugin-system` 包
- 统一的插件接口和生命周期
- 扩展点注册和钩子系统
- 分布式事务协调器

### ADR-003: Schema-First 设计
**决策日期**: 2024-12-15
**状态**: ✅ 已确认

**决策**: 以 Zod Schema 为单一数据源

**背景**: 需要减少重复定义，提高开发效率

**决策理由**:
- ✅ 减少重复定义
- ✅ 类型安全
- ✅ 自动化代码生成
- ✅ 开发效率高
- ✅ 支持模块化 Schema 合并

**影响**: 所有数据相关代码都基于 Schema 生成

## 🔑 技术栈决策

### 核心原则

#### 少重复造轮子 ⭐ **最高优先级**
优先使用现有成熟方案，避免重新发明轮子：
- **充分调研现有方案**：在选择技术栈前充分调研生态系统
- **优先集成而非自研**：通过适配器模式集成现有优秀工具
- **谨慎评估自研需求**：只有在现有方案无法满足需求时才考虑自研
- **示例决策**：
  - ✅ 使用 Prisma 事务系统而非自研 TransactionManager
  - ✅ 使用 NextAuth.js 而非自研认证系统
  - ✅ 使用 shadcn/ui 而非完全自研 UI 组件库
  - ✅ 使用 cls-hooked 实现跨模块事务传播

#### AI-First 设计
所有技术选择都考虑 AI 的理解和使用便利性：
- 完整的类型定义
- 清晰的接口设计
- 标准化的命名约定
- 丰富的文档注释

#### 开发效率优先
选择能够显著提升开发效率的技术：
- 减少样板代码
- 自动化代码生成
- 强类型支持
- 优秀的开发工具

### 核心技术选择

#### Next.js 14 (App Router)
**选择原因**:
- ✅ 全栈框架，支持 SSR/SSG/ISR
- ✅ 优秀的开发体验和性能
- ✅ 强大的生态系统
- ✅ 内置 API Routes，减少后端复杂性

**替代方案**: Remix, Nuxt.js, Vite + React
**决策时间**: 2024-12-15

#### Zod Schema 系统
**选择原因**:
- ✅ TypeScript 原生支持
- ✅ 运行时验证
- ✅ 优秀的错误提示
- ✅ 丰富的验证规则
- ✅ 可组合性强

**替代方案**: Joi, Yup, io-ts
**决策时间**: 2024-12-15
**关键决策**: 这是整个 Schema 系统的基础

#### Prisma ORM
**选择原因**:
- ✅ 类型安全的数据库访问
- ✅ 优秀的开发体验
- ✅ 强大的迁移系统
- ✅ 多数据库支持
- ✅ 与 TypeScript 深度集成

**替代方案**: Drizzle, TypeORM, Sequelize
**决策时间**: 2024-12-15

#### shadcn/ui
**选择原因**:
- ✅ 基于 Radix UI，无障碍性好
- ✅ 可定制性强，不是黑盒
- ✅ 现代设计风格
- ✅ TypeScript 原生支持
- ✅ 复制粘贴模式，无运行时依赖

**替代方案**: Ant Design, Material-UI, Chakra UI
**决策时间**: 2024-12-15

---

**相关文档**:
- [插件系统设计](./plugin-system-design.md)
- [发布策略](../management/publishing-strategy.md)
- [开发标准](../standards/development-standards.md)
