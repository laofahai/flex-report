# Linch Kit 开发规范（永久性标准）

> **永久性原则**：本规范确立后仅允许三类变更：
> 1. 新增非冲突性条款
> 2. 优化表述清晰度
> 3. 补充实施细则
> 禁止修改或删除已确立的核心条款。

> **⚠️ 不可违背声明**：此文档为 Linch Kit 项目的核心开发标准，任何开发活动都必须严格遵循，不得违背或绕过任何条款。

## 🔒 核心开发标准（强制执行）

### 1. TypeScript 严格要求（强制执行）

#### 基本要求
- **所有文件必须使用 TypeScript (.ts/.tsx)**，禁止转换为 .js 绕过问题
- **修复工具链而非绕过问题**：遇到 TypeScript 错误时，必须修复根本原因
- **优先使用具体类型定义**，避免过度使用 'as xxx' 断言
- **启用严格模式**，避免使用 `any` 类型

#### 类型共享
- **通过 `@linch-kit/types` 包共享核心接口**
- **使用 Zod Schema 作为单一数据源**，自动生成 TypeScript 类型
- **tRPC 提供端到端类型安全**

#### Zod Schema 最佳实践（强制执行）
- **禁止使用 `z.any()` 类型**：必须使用 `z.unknown()` 替代，避免类型推导问题
- **禁止使用 `z.record(z.any())` 类型**：必须使用 `z.record(z.string(), z.unknown())` 或更具体的类型
- **JSON 字段类型安全**：所有 JSON 字段必须明确指定键和值的类型范围
- **复杂类型处理**：避免过度嵌套的泛型类型定义，防止 TypeScript 编译器卡住
- **Schema 性能优化**：大型 Schema 应拆分为更小的可组合单元
- **类型推导优化**：使用具体类型而非 `any`，确保编译器能正确推导类型

#### TypeScript 类型生成要求（强制执行）
- **TypeScript 类型生成（DTS）是强制要求**，不允许跳过或禁用
- **所有包构建必须包含完整的类型定义文件**
- **修复类型错误而非绕过**：遇到类型生成问题时，必须修复根本原因
- **类型文件完整性检查**：构建后必须验证 .d.ts 文件正确生成

#### ESLint 强制要求
- **修改后必须运行** `npx eslint --fix`
- **所有 lint 错误必须修复**，不允许提交有 lint 错误的代码
- **使用 ESLint 禁用注释时必须说明原因**

#### Node.js 环境要求
- **运行 npm/pnpm 命令时必须使用前缀**：
  ```bash
  export PATH="/home/laofahai/.nvm/versions/node/v20.19.2/bin:$PATH"
  ```

### 2. JSDoc 文档标准（必须）

**完整的JSDoc注释标准请查看**: **[文档标准](./documentation-standards.md#jsdoc-注释标准)**

**核心要求**：
- 所有新增或修改的方法必须包含完整的JSDoc注释
- 必需标签：@description、@param、@returns、@throws、@example、@since
- 使用TypeScript类型注解配合JSDoc文档

### 3. ES 模块兼容性（必须）

#### 保留字冲突避免
- **禁止使用 `module` 作为变量名**（ES 模块保留字）
- **使用 `typeof module !== 'undefined'` 检查 CommonJS 环境**

#### 动态导入处理
- **为动态导入提供完整的错误处理和回退机制**
- **优先使用 ES 模块导出语法**

#### 环境检测
```typescript
// 正确的环境检测方式
if (typeof module !== 'undefined' && module.exports) {
  // CommonJS 环境
} else {
  // ES 模块环境
}
```

### 4. 架构一致性原则（必须）

#### 重复实现禁止
- **禁止跨包重复实现**，使用统一核心接口
- **公共模块实现** 所有应用模块功能应查看/packages/*下的功能是否已实现
- **优先使用现有成熟解决方案**，避免重复造轮子

#### 破坏性变更禁止
- **不允许破坏性变更**，必须修复根本原因而非创建变通方案
- **向后兼容性优先**

#### 生成文件管理
- **生成文件只能通过 CLI 命令自动生成**：
  - `prisma/schema.prisma`
  - `validators`
  - `mocks`
  - `openapi`
- **禁止手动编辑生成文件**

### 5. 包管理规范（必须）

#### 依赖管理
- **必须使用包管理器（pnpm）管理依赖**
- **禁止手动编辑包配置文件**

#### 例外情况
- **仅在复杂配置变更时**才可直接编辑包文件（如自定义脚本、构建配置）

### 6. 国际化 (i18n) 要求（强制执行）

#### 基本要求
- **所有包必须支持国际化**：新开发的包都必须内置 i18n 支持
- **禁止自行实现 i18n 功能**：不得重复造轮子，避免功能重复
- **使用统一 i18n 工具**：必须使用 `@linch-kit/core` 包提供的 i18n 方法和工具

#### 实现标准
```typescript
// 在包的 i18n/index.ts 中
import { createPackageI18n } from '@linch-kit/core'

const packageI18n = createPackageI18n({
  packageName: 'ui',
  defaultLocale: 'en',
  defaultMessages: {
    en: {
      'table.search': 'Search...',
      'table.noResults': 'No results found.'
    },
    'zh-CN': {
      'table.search': '搜索...',
      'table.noResults': '暂无数据'
    }
  }
})

// 导出翻译函数
export const uiT = (userT?: TranslationFunction) => packageI18n.getTranslation(userT)
```

#### 多语言文件管理
- **统一的语言文件组织**：每个包在 `src/i18n/` 目录下管理语言文件
- **命名规范**：使用 `packageName.key` 格式的键名，避免冲突
- **默认语言支持**：至少支持英文 (en) 和中文 (zh-CN)
- **回退机制**：提供默认消息，确保在翻译缺失时的用户体验

## 🏗️ 架构设计原则

### 数据库设计
- **优先使用 JSON 字段**而非多对多关系以降低复杂性
- **默认实现强制软删除**
- **自动数据库提供商检测**用于 schema 生成
- **避免重复唯一约束**防止命名冲突

### 数据库连接配置（必须）
- **使用 PgBouncer 模式**避免 prepared statement 冲突：
  ```
  DATABASE_URL="postgresql://...?pgbouncer=true&connection_limit=1"
  ```
- **Prisma 客户端单例模式**：使用全局变量避免多实例冲突
- **优雅关闭连接**：在进程退出时调用 `$disconnect()`
- **连接池日志配置**：开发环境启用查询日志，生产环境仅错误日志

### 配置管理
- **服务器/客户端配置分离**，敏感数据存储在 .env 文件
- **统一数据库配置**在 linch.config 而非 .env 文件
- **CLI 生成配置**而非手动文件编辑

### 插件系统
- **优先使用消息/事件总线系统**而非钩子进行插件间通信
- **更好的失败处理和异步处理**

## 📦 包设计标准

### 核心包结构
- **核心包位于 /packages**，用于 npm 发布
- **应用仅包含启动器**
- **基于插件的开发**，功能模块作为插件

### CLI 和配置
- **优先使用冒号分隔命令名**（schema:command）而非破折号分隔
- **CLI 命令应修改配置**而非手动文件编辑
- **支持动态命令和配置注册**

## 🧪 测试要求

### 单元测试
- **编写代码时建议编写测试**
- **修复功能必须添加测试覆盖**
- **测试驱动开发优先**

### 验证流程
每次修改后必须运行：
```bash
# 生成 Prisma schema
pnpm linch schema:generate:prisma

# 运行 lint 检查
pnpm lint

# 运行测试（如果存在）
pnpm test
```

## 🎨 UI组件开发标准（强制执行）

**完整的UI组件开发标准请查看**: **[UI组件标准](./ui-standards.md)**

### 核心要求摘要
- **所有 shadcn/ui 组件必须通过官方 CLI 命令添加**
- **组件添加目标目录**: `packages/ui/src/components/`
- **跨模块通用组件统一放置在 @linch-kit/ui 包中**，避免重复实现
- **组件自定义修改必须保持与 shadcn/ui 更新兼容性**

### 快速添加组件命令
```bash
# 设置 Node.js 环境
export PATH="/home/laofahai/.nvm/versions/node/v20.19.2/bin:$PATH"

# 进入 UI 包目录并添加组件
cd packages/ui
npx shadcn@latest add [component-name]
pnpm build && pnpm lint
```

**详细的组件开发工作流程、文件结构规范、质量要求、测试标准等请参考**: **[UI组件标准](./ui-standards.md)**

## 📚 文档标准（强制执行）

### 中文文档优先
- **优先使用中文文档**
- **统一 AI 上下文文档**仅在根目录
- **遵循开发工作流程** ai-context/workflows/development.md

### 代码注释
- **所有公共 API 必须有 JSDoc**
- **复杂逻辑必须有行内注释**
- **TODO 注释必须包含负责人和时间**

### 文档同步更新（强制要求）
- **每次功能更新后必须同步更新 ai-context 中的相关文档**
- **严格按照 [文档标准](./documentation-standards.md) 执行文档维护**
- **更新内容包括但不限于**：
  - `current-progress.md` - 开发进度状态
  - 相关的技术文档和架构说明
- **文档更新必须在代码提交的同一次会话中完成**

### 包文档同步维护（强制要求）
- **包代码更新后必须同步更新该包的 `README.md` 文件**
- **包级 README.md 最小内容要求**：
  - **API 文档**：主要接口和方法的使用说明
  - **安装说明**：依赖安装和配置步骤
  - **使用示例**：常见用法的代码示例
  - **变更日志**：版本更新和功能变更记录
  - **贡献指南**：开发和贡献流程说明
- **包文档更新检查清单**：
  - [ ] API 变更已在 README 中更新
  - [ ] 新功能已添加使用示例
  - [ ] 版本信息和依赖关系准确
  - [ ] 安装和配置说明完整
- **验证机制**：包发布前必须确认文档与代码实现一致

## 🔄 开发工作流程

### 信息收集阶段
1. **使用 codebase-retrieval 工具了解当前状态**
2. **制定详细计划**，列出需要修改的文件
3. **获取所有相关符号的详细信息**

### 编辑阶段
1. **使用 str-replace-editor 而非重写文件**
2. **调用 codebase-retrieval 获取编辑相关的详细信息**
3. **保守修改，尊重现有代码库**

### 验证阶段
1. **运行所有验证命令**
2. **确保无破坏性变更**
3. **添加或更新测试**

## ⚠️ 违规处理

### 检查清单
每次开发任务完成前必须确认：
- [ ] 所有文件使用 TypeScript
- [ ] 运行了 `npx eslint --fix`
- [ ] 添加了完整的 JSDoc 注释
- [ ] 通过了所有验证命令
- [ ] 没有破坏性变更
- [ ] 使用了包管理器管理依赖
- [ ] **已同步更新 ai-context 中的相关文档**
- [ ] **已遵循文档最佳实践标准**

### 强制执行
- **任何违反此规范的代码不得合并**
- **必须修复所有违规问题后才能继续**
- **规范更新需要团队一致同意**

## 🤖 AI-First 开发最佳实践

### 代码编写原则
- **类型定义优先**: 完整的 TypeScript 类型定义，便于 AI 理解参数结构
- **清晰的函数命名**: 使用动词+名词的命名方式，避免模糊命名
- **丰富的注释**: 所有公共接口必须有 JSDoc 注释，复杂逻辑必须有内联注释

### 配置文件最佳实践
```typescript
// ✅ 好的实践：详细的配置注释
export default defineConfig({
  /** 项目基本信息 */
  project: {
    name: 'my-enterprise-app',
    version: '1.0.0',
    description: '企业级管理系统'
  },

  /** 数据库配置 */
  database: {
    provider: 'postgresql',
    url: process.env.DATABASE_URL
  }
})
```

### 文档编写标准
- **README 文件结构**: 包含快速开始、环境要求、基本使用、详细文档链接
- **API 文档格式**: 使用 JSDoc 标准，包含参数类型、返回值、示例代码
- **错误处理文档**: 记录常见问题和解决方案

### 项目经验总结
- **优先使用现有成熟方案**: 避免重复造轮子，通过适配器模式集成现有工具
- **Schema 驱动开发**: 使用 `@linch-kit/schema` 作为单一数据源，自动生成相关代码
- **渐进式开发**: 小步快跑，逐步重构，保持向后兼容性
- **质量优于速度**: 架构一致性比临时解决方案更重要

## 🔄 AI上下文管理规范（强制执行）

### 上下文容量监控
- **监控阈值**: 当对话上下文超过85%容量时必须执行强制处理流程
- **容量评估**: 基于token数量、对话轮次、代码修改量等综合指标
- **预警机制**: 在接近阈值时提前规划任务分割点

### 强制处理流程
当上下文超过85%时，必须按以下顺序执行：

#### 1. 立即停止当前工作
- **停止所有正在进行的代码修改**
- **完成当前正在编辑的文件**（如果修改已开始）
- **不开始新的复杂任务或文件修改**

#### 2. 更新进度文档
**必须详细更新 `current-progress.md`**，包含：

```markdown
### 🔄 当前会话进度记录 (YYYY-MM-DD HH:MM)

#### ✅ 已完成任务
- [x] 任务名称 - 具体完成内容和结果
- [x] 文件修改 - 具体修改的文件路径和主要变更

#### 🔄 进行中任务
- [ ] 任务名称 - 当前进度百分比，具体停止点
- [ ] 文件路径 - 已修改内容，待完成内容

#### ❌ 遇到的问题
- 问题描述 - 具体错误信息，尝试的解决方案
- 阻塞点 - 需要解决的技术难题或依赖问题

#### 📋 下一步操作
- 优先级1: 具体任务描述和执行步骤
- 优先级2: 后续任务和依赖关系
```

#### 3. 生成新会话启动prompt
**必须创建包含以下内容的启动prompt**：

```markdown
# 继续开发 - 会话接续 (YYYY-MM-DD)

## 📋 已完成任务清单
[从current-progress.md复制已完成任务]

## 🔄 当前任务进度
**任务**: [具体任务名称]
**进度**: [具体百分比和停止点]
**文件状态**: [已修改的文件和待修改的文件]

## 🎯 下一步操作详细步骤
1. **立即执行**: [具体操作步骤]
2. **验证要求**: [需要检查的内容]
3. **完成标准**: [任务完成的判断标准]

## 📁 相关文件路径
- 主要文件: [文件路径] - [修改要点]
- 依赖文件: [文件路径] - [关联关系]

## 🔧 关键修改要点
- [具体的代码修改点]
- [配置变更要求]
- [测试验证步骤]

## ⚠️ 重要提醒
- 严格遵循 [开发规范](ai-context/zh/standards/development-standards.md)
- 使用 codebase-retrieval 工具了解代码现状
- 每次修改后运行 npx eslint --fix
```

### 文档更新要求
- **同步更新**: 进度记录必须与实际工作状态完全一致
- **详细记录**: 包含足够的细节以便新会话无缝接续
- **标准格式**: 遵循 [文档标准](./documentation-standards.md) 的格式要求

### 质量保证
- **验证完整性**: 确保所有重要信息都已记录
- **测试可用性**: 新会话启动prompt必须包含足够的上下文信息
- **维护一致性**: 与现有文档标准和工作流程保持一致

---

**最后更新**：2025-06-21
**版本**：v1.3.0 (新增 AI上下文管理规范)
**状态**：永久生效，仅可优化补充

**重要提醒**: 所有开发工作都必须严格遵循这些标准和最佳实践，确保代码质量和项目的长期可维护性。
