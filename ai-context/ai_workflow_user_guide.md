# LinchKit AI 工作流 - 用户使用指南

**版本**: v1.0  
**适用用户**: 开发者、产品经理、技术主管  
**技能要求**: 无需技术背景，只需自然语言描述需求

## 🎯 快速开始

### 第一步：切换到工作流目录

```bash
cd .devcontainer/workflow-mvp
```

### 第二步：描述你的需求

```bash
./scripts/ai-workflow-generator.sh "你的开发需求"
```

**就这么简单！** AI 会自动：
1. 理解你的需求
2. 生成完整的开发工作流
3. 执行所有必要的开发任务
4. 确保代码质量和规范遵守

## 📝 如何描述需求

### ✅ 好的需求描述

| 场景 | 描述示例 | AI 会做什么 |
|------|----------|-------------|
| **认证功能** | "为用户模块添加 JWT 认证支持" | 自动配置认证包、实现JWT逻辑、添加权限控制 |
| **数据管理** | "创建用户管理的数据表格，支持增删改查" | 生成CRUD操作、数据模型、表单验证 |
| **API开发** | "重构用户API，添加批量操作和搜索功能" | 重新设计API结构、实现批量操作、优化搜索 |
| **UI组件** | "创建可复用的按钮组件，支持多种样式" | 设计组件结构、实现样式变体、添加文档 |
| **测试开发** | "为用户模块编写完整的单元测试" | 分析现有代码、生成测试用例、确保覆盖率 |

### ❌ 避免模糊的描述

| 模糊描述 | 问题 | 改进建议 |
|----------|------|----------|
| "优化一下系统" | 太宽泛，不知道优化什么 | "优化用户查询API的响应速度" |
| "修复bug" | 没有指明具体bug | "修复用户登录时的token过期问题" |
| "改进界面" | 不清楚改进哪个界面 | "改进用户管理页面的表格布局" |
| "添加功能" | 没有说明具体功能 | "添加用户头像上传功能" |

## 🚀 典型使用场景

### 场景1：开发新功能

**需求**: "我需要一个用户评论系统，支持回复和点赞"

**AI 执行流程**:
1. 🧠 **需求分析**: 识别为 CRUD + UI 功能
2. 📋 **工作流生成**: 
   - 创建评论数据模型
   - 实现CRUD API
   - 开发前端组件
   - 添加测试用例
3. ⚙️ **自动执行**: 
   - 创建功能分支
   - 实现所有代码
   - 运行测试和质量检查
   - 准备代码审查

**用户只需**: 描述需求 → 等待完成 → 代码审查

### 场景2：修复和优化

**需求**: "优化用户查询API的性能，支持分页和缓存"

**AI 执行流程**:
1. 🤖 **Gemini 协商**: 由于是重构任务，自动启用AI协商
2. 📊 **技术分析**: 分析现有API结构和性能瓶颈
3. 🛠️ **实施方案**: 
   - 添加分页逻辑
   - 集成缓存机制
   - 优化数据库查询
   - 更新文档

### 场景3：测试开发

**需求**: "为支付模块编写完整的测试用例"

**AI 执行流程**:
1. 📖 **代码分析**: 自动分析支付模块的代码结构
2. 🧪 **测试设计**: 生成单元测试、集成测试、边界测试
3. 📈 **覆盖率保证**: 确保测试覆盖率达到 80% 以上
4. 🔍 **质量验证**: 运行所有测试，确保通过率 100%

## 🤖 AI 智能特性

### 自动任务识别

AI 会根据关键词自动识别任务类型：

| 关键词 | 识别类型 | 涉及包 |
|--------|----------|--------|
| 认证、登录、JWT、OIDC | `authentication` | @linchkit/auth |
| 增删改查、数据库、CRUD | `crud` | @linchkit/crud, @linchkit/schema |
| 界面、组件、UI、前端 | `ui` | @linchkit/ui |
| API、接口、路由、服务 | `api` | @linchkit/trpc |
| 测试、单元测试、覆盖率 | `testing` | 全包测试 |
| 重构、优化、架构 | `refactor` | 触发Gemini协商 |

### 智能复杂度评估

- **低复杂度**: 修复、简单功能 → 自动执行
- **中复杂度**: 新功能、组件开发 → 适度自动化
- **高复杂度**: 重构、架构变更 → 启用AI协商

### Gemini 协商机制

对于复杂任务，AI 会自动启用 Gemini 协商：
- 🤝 **技术方案讨论**: 多个AI代理协商最佳实施方案
- 🎯 **风险评估**: 识别潜在风险和解决方案
- 📋 **任务分解**: 将复杂任务分解为可执行的步骤
- 🛡️ **约束遵守**: 确保方案符合LinchKit开发规范

## 🔄 工作流执行过程

### 1. 环境检查阶段

AI 会自动检查和处理：
- ✅ **依赖验证**: 确保 bun、git、jq 等工具可用
- ✅ **分支安全**: 自动创建功能分支，保护主分支
- ✅ **工作目录**: 智能处理未提交的更改

**智能文件处理选项**:
- **自动提交**: AI 生成的文件自动提交
- **暂存处理**: 用户修改的文件提供多种处理选项
- **清理模式**: 可选择清理临时文件

### 2. 工作流生成阶段

- 🧠 **需求解析**: 从自然语言提取技术需求
- 📋 **任务规划**: 生成详细的执行步骤
- 🛡️ **约束集成**: 强制执行LinchKit开发规范
- ⚙️ **自动化配置**: 根据任务复杂度选择执行模式

### 3. 执行监控阶段

**实时进度显示**:
```
✓ setup-branch: 分支创建完成
⚙ install-deps: 正在安装依赖...
⏳ build-project: 构建队列中
⏹ run-tests: 等待依赖完成
```

**智能错误处理**:
- 🔍 **自动诊断**: AI 分析错误原因
- 💡 **修复建议**: 提供具体的解决方案
- 🔄 **重试机制**: 支持任务重新执行

## 📊 监督和控制

### 执行监控

#### 查看实时状态
```bash
# 查看当前所有工作流状态
ls -la state/

# 查看特定工作流详情  
cat state/工作流ID.state.json
```

#### 状态解读
```json
{
  "status": "running",        // 整体状态: running/completed/failed
  "current_task": "build",    // 当前执行任务
  "progress": {
    "completed": 3,           // 已完成任务数
    "total": 7,              // 总任务数
    "percentage": 43         // 完成百分比
  }
}
```

### 执行控制

#### 暂停工作流
```bash
# 方法1: Ctrl+C 中断当前执行
# 方法2: 删除状态文件强制停止
rm state/工作流ID.state.json
```

#### 恢复执行
```bash
# 重新执行工作流(自动跳过已完成任务)
./scripts/run-workflow.sh tasks/工作流配置.json
```

#### 手动干预
```bash
# 查看生成的工作流配置
cat tasks/ai-generated-工作流ID.json

# 手动修改配置后重新执行
./scripts/run-workflow.sh tasks/ai-generated-工作流ID.json
```

## 🚨 故障排除

### 常见问题和解决方案

#### 1. 环境检查失败

**问题**: "缺少必要依赖: bun"  
**解决**: 
```bash
# 安装 bun
curl -fsSL https://bun.sh/install | bash
source ~/.bashrc
```

**问题**: "工作目录有未提交更改"  
**解决**: 选择AI提供的处理方式：
- 选择 "1" 自动提交所有更改
- 选择 "2" 暂存更改继续执行
- 选择 "3" 手动处理后重新运行

#### 2. 任务执行失败

**测试失败**:
```bash
# AI建议: 检查测试用例或更新快照
bun test --updateSnapshot
```

**构建失败**:
```bash
# AI建议: 检查TypeScript类型错误
bun run check-types
```

**代码质量失败**:
```bash
# AI建议: 运行自动修复
bun run lint:fix
```

#### 3. 工作流卡住

**识别卡住的任务**:
```bash
# 查看状态文件，找到 status: "running" 的任务
cat state/工作流ID.state.json | jq '.tasks[] | select(.status=="running")'
```

**手动完成任务**:
```bash
# 手动执行卡住的命令
cd worktrees/项目目录
# 执行具体命令...

# 手动标记任务完成
# 编辑状态文件，将任务状态改为 "completed"
```

### 紧急重置

如果系统状态完全混乱：

```bash
# 1. 清理所有状态
rm -rf state/*.state.json
rm -rf tasks/ai-generated-*
rm -rf worktrees/*

# 2. 提交或暂存当前更改
git add .
git commit -m "手动清理AI工作流状态"

# 3. 重新开始
./scripts/ai-workflow-generator.sh "你的需求"
```

## 💡 高级技巧

### 1. 分阶段执行

对于复杂需求，可以分解为多个阶段：

```bash
# 第一阶段: 数据模型
./scripts/ai-workflow-generator.sh "设计用户评论的数据模型和Schema"

# 第二阶段: API开发  
./scripts/ai-workflow-generator.sh "实现用户评论的CRUD API"

# 第三阶段: 前端组件
./scripts/ai-workflow-generator.sh "创建用户评论的前端组件"
```

### 2. 质量优先模式

```bash
# 明确要求高质量输出
./scripts/ai-workflow-generator.sh "创建企业级的用户权限管理系统，要求100%测试覆盖率和完整文档"
```

### 3. 性能优先模式

```bash
# 强调性能要求
./scripts/ai-workflow-generator.sh "优化产品列表API，要求支持10万级数据量和亚秒级响应"
```

## 🎯 最佳实践

### Do's ✅

1. **明确具体**: 描述清楚要实现什么功能
2. **包含上下文**: 说明功能的使用场景和约束
3. **分解复杂任务**: 将大功能拆分为小任务
4. **定期检查**: 监控执行状态和质量指标
5. **及时干预**: 发现问题及时手动修正

### Don'ts ❌

1. **不要模糊描述**: 避免"优化"、"改进"等模糊词汇
2. **不要忽略错误**: 任务失败时要查看具体原因
3. **不要强制中断**: 除非必要，让任务自然完成
4. **不要跳过约束**: LinchKit 约束是质量保证，不要绕过
5. **不要同时运行**: 避免同时执行多个大型工作流

---

**🚀 LinchKit AI 工作流让每个人都能成为高效的全栈开发者！**

只需描述你的想法，AI 自动完成从设计到实现的全过程。开始你的AI驱动开发之旅吧！