# LinchKit 核心约束与规则

**版本**: v8.0 - AI代码质量保证  
**目标大小**: ≤3KB  
**覆盖范围**: 80%+ 常规开发任务  
**更新时间**: 2025-01-11

## 🔴 零容忍约束 (AI必须100%遵守)

### 1. Graph RAG 强制查询

```bash
# 任何代码相关任务前必须执行
bun run ai:session query "[关键词]"
```

**违规处理**: 立即停止任务，重新执行查询

### 2. 分支管理严格要求

- **绝对禁止**: 在 `main`、`master`、`develop`、`release/*` 分支直接工作
- **强制要求**: 创建功能分支 `feature/[task-name]` 或 `fix/[issue-name]`
- **检查命令**: `git branch --show-current`

### 3. 包管理唯一标准

- **唯一工具**: `bun`（严禁使用 npm/yarn）
- **包复用**: 必须使用 LinchKit 内部包，禁止重复实现
- **检查命令**: `bun run deps:check "[关键词]"`

### 4. TypeScript 超严格模式

- **禁止 `any` 类型**: 使用 `unknown` 替代
- **禁止类型断言**: 使用类型守卫替代 `as` 断言
- **禁止 `@ts-ignore`**: 必须修复所有类型错误
- **强制验证**: 所有外部数据必须通过 Zod Schema 验证

### 5. 测试同步强制要求

- **新功能开发**: 必须同时包含完整测试
- **功能修改**: 必须同步更新相关测试
- **覆盖率要求**: 核心包95%+，其他包90%+
- **验证命令**: `bun test --coverage`

### 6. 错误处理完整性

- **异步操作**: 所有 Promise 必须处理错误
- **边界检查**: 数组访问、对象属性必须验证
- **资源管理**: 所有资源必须正确释放
- **日志记录**: 使用 `@linch-kit/core` 统一日志系统

### 7. 代码质量门禁

- **ESLint**: 必须0错误0警告
- **TypeScript**: 必须0类型错误
- **构建**: 必须成功无警告
- **验证命令**: `bun run validate:light`

## 🎯 核心开发流程

### 开发前强制检查 (3步验证)

```bash
# 1. 环境检查
git branch --show-current  # 确认功能分支
git status                 # 工作目录状态

# 2. 上下文查询 (Graph RAG)
bun run ai:session query "[核心功能]"
bun run ai:session symbol "[类名/函数名]"

# 3. 包复用检查
bun run deps:check "[功能关键词]"
```

### 开发中持续要求

- **输入验证**: 所有函数参数用 Zod Schema 验证
- **类型安全**: 使用类型守卫，避免类型断言
- **错误处理**: 异步操作必须 try-catch 或 Result 类型
- **测试同步**: 功能实现的同时编写测试

### 提交前质量门禁

```bash
# 必须全部通过
bun run validate:light    # 快速质量检查
bun test                  # 所有测试通过
bun build                 # 构建成功
```

## 🔧 必备命令速查

### Graph RAG 查询

```bash
bun run ai:session query "[实体名]"        # 查询实体定义
bun run ai:session symbol "[符号名]"       # 查询符号位置
bun run ai:session pattern "[模式]" "[实体]" # 查询实现模式
bun run ai:session sync                    # 同步图谱数据
```

### 质量验证

```bash
bun run validate:light    # 快速验证 (格式+lint)
bun run validate          # 完整验证 (build+test)
bun test --coverage       # 测试覆盖率检查
bun run lint:fix          # 自动修复格式问题
```

### 包管理

```bash
bun run deps:check "[关键词]"  # 检查包复用
bun install                    # 安装依赖
bun run build                  # 项目构建
```

## 🚨 应急处理指南

### 常见违规场景处理

#### 1. Graph RAG 查询失败

```bash
# 检查网络连接
bun run ai:session query "test"

# 重试查询
bun run ai:session query "[实际关键词]"

# 如持续失败，使用现有文档作为替代
```

#### 2. 类型错误处理

```typescript
// ❌ 错误做法
const data = apiResponse as User

// ✅ 正确做法
function isUser(value: unknown): value is User {
  return typeof value === 'object' && value !== null && 'id' in value && 'name' in value
}

if (isUser(apiResponse)) {
  // 安全使用 apiResponse
}
```

#### 3. 测试失败处理

- **不跳过测试**: 修复失败的测试
- **不降低覆盖率**: 保持或提高测试覆盖率
- **不忽略边界**: 补充边界条件测试

#### 4. 构建失败处理

- **类型错误**: 使用类型守卫修复
- **依赖问题**: 检查 `package.json` 和 `bun.lockb`
- **配置错误**: 查看 `tsconfig.json` 和构建配置

## 📋 质量标准清单

### 每个任务必须满足

- [ ] 在功能分支开发 (非保护分支)
- [ ] 完成必要的 Graph RAG 查询
- [ ] 通过所有质量检查 (validate:light)
- [ ] 包含完整测试用例
- [ ] 构建成功无错误
- [ ] 代码符合类型安全要求
- [ ] 错误处理完整
- [ ] 使用 LinchKit 内部包 (无重复实现)

### 提交前最终检查

- [ ] `git status` 工作目录干净
- [ ] `bun run validate:light` 通过
- [ ] `bun test` 全部通过
- [ ] `bun build` 成功
- [ ] 提交信息格式正确
- [ ] 包含 Claude Code 标识

## 🎯 成功标准

### 核心目标

- **80%常规任务**: 仅凭此文档即可完成
- **零错误保证**: 严格遵守所有约束
- **质量一致性**: 每次输出都符合标准
- **效率提升**: 减少返工和错误修复

### 衡量指标

- **约束遵守率**: 目标 95%+
- **代码质量**: ESLint 0错误，TypeScript 0错误
- **测试覆盖率**: 核心包95%+，其他90%+
- **构建成功率**: 目标 100%

---

**设计原则**: 每个约束都可执行、可验证、不可违反  
**更新策略**: 基于使用反馈持续优化  
**大小控制**: 严格保持 ≤ 3KB  
**适用范围**: LinchKit 项目所有 AI 代码生成任务
