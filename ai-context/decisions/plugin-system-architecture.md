# 插件系统架构决策

*决策日期: 2024-12-18*

## 🎯 背景

Linch Kit 需要一个灵活的模块化架构，支持业务模块的动态组合和功能扩展。经过分析和讨论，确定采用基于 Odoo 理念的运行时插件系统。

## 🏗️ 核心架构决策

### 1. 插件系统定位
**决策**: 创建独立的 `@linch-kit/plugin-system` 包

**理由**:
- 职责清晰：运行时插件系统是独立的功能域
- 版本管理：可以独立发版，不影响 core 包
- 依赖隔离：避免 core 包过于臃肿
- 复用性：其他项目也可以使用这个插件系统

### 2. 模块 vs 插件概念
**决策**: 统一接口，类型区分

- **应用模块**: 完整的业务功能模块（如 WMS、CRM、HR）
- **功能插件**: 对现有模块的功能增强或扩展
- **统一接口**: 两者都实现相同的 Plugin 接口
- **类型标识**: 通过 `type: 'module' | 'plugin'` 区分

### 3. 技术栈集成策略
**决策**: 保持现有包的独立性，通过扩展点集成

- `@linch-kit/trpc`: 保持独立包
- `@linch-kit/auth-core`: 调整支持模块化权限
- `@linch-kit/crud`: 新建包，提供通用视图
- `@linch-kit/schema`: 继续作为数据模型基础

### 4. 跨模块事务管理
**决策**: 分阶段实现事务管理

**第一阶段**: 简单的数据库事务（基于 Prisma）
**第二阶段**: 跨模块补偿事务（Saga 模式）
**第三阶段**: 完整的分布式事务（2PC）

**理由**: 
- 避免过度设计
- 快速验证架构可行性
- 为未来扩展留下空间

## 🚀 实施优先级

### 第一阶段：基础设施完善
1. ✅ 确定 tRPC 位置：保持独立包
2. 🔄 完善权限系统：调整 auth-core 支持模块化权限
3. 🔄 创建 CRUD 包：实现通用视图组件
4. 🔄 事务管理设计：设计跨模块事务管理机制

### 第二阶段：插件系统核心
1. 创建插件系统包：`@linch-kit/plugin-system`
2. 实现核心功能：插件注册、生命周期、扩展点
3. 事务管理器：实现分布式事务协调器
4. 集成现有系统：与 schema、auth、ui、事务系统集成

### 第三阶段：开发工具和优化
1. CLI 集成：插件管理命令
2. 开发工具：插件脚手架、验证、测试
3. 性能优化：懒加载、缓存、并行处理

## 🔑 关键设计原则

### 1. 少重复造轮子 ⭐ **最高优先级**
- **优先使用现有成熟方案**：如 Prisma 事务系统、cls-hooked、NextAuth.js 等
- **避免重新实现已有功能**：充分利用生态系统中的优秀工具
- **谨慎评估自研需求**：只有在现有方案无法满足需求时才考虑自研
- **集成而非替代**：通过适配器模式集成现有方案
- **具体应用**：
  - 使用 Prisma Interactive Transactions 而非自研 TransactionManager
  - 使用 cls-hooked 实现跨模块事务传播
  - 基于 NextAuth.js 扩展权限系统

### 2. AI-First 设计
- 所有接口和配置都便于 AI 理解
- 完整的类型定义和文档注释
- 标准化的命名和结构

### 3. 类型安全
- 完整的 TypeScript 支持
- 编译时类型检查
- 运行时类型验证

### 4. 灵活性优先
- 支持多种扩展方式
- 最小化强制约束
- 向后兼容性考虑

### 5. 性能考虑
- 懒加载机制
- 缓存策略
- 并行处理

## 📊 风险评估

### 高风险
- **跨模块事务复杂性**: 分布式事务的实现和调试复杂
- **性能影响**: 动态加载可能影响启动性能

### 中风险
- **依赖管理**: 模块间依赖关系的复杂性
- **版本兼容**: 不同版本模块的兼容性问题

### 低风险
- **开发体验**: CLI 工具和开发工具的完善程度
- **文档维护**: 架构复杂性带来的文档维护成本

## 🔄 后续评估

- **3个月后**: 评估基础架构的可行性
- **6个月后**: 评估事务管理的实现效果
- **1年后**: 评估整体架构的扩展性和性能

## 📝 相关文档

- [插件系统核心设计](../architecture/plugin-system-core.md)
- [项目总览](../project-overview.md)
- [当前开发状态](../progress/current-status.md)
